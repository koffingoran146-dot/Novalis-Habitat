<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novalis ‚Äì Admin minimale (Supabase)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b1020;--panel:#111936;--muted:#98a2b3;--fg:#e6eaf2;--acc:#7c93ff;--ok:#2ecc71;--err:#ff5c5c}
    *{box-sizing:border-box}body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial;background:linear-gradient(180deg,#0b1020 0%,#0d1326 100%);color:var(--fg)}
    header{padding:20px 16px;border-bottom:1px solid #1b2550;background:#0c1226;position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;gap:16px}
    .card{background:var(--panel);border:1px solid #1c2752;border-radius:16px;padding:14px 14px 10px;box-shadow:0 4px 24px rgba(10,15,40,.3)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{border-radius:10px;border:1px solid #253063;background:#0d1430;color:var(--fg);padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:var(--acc);border-color:#4157ff;color:white;font-weight:600}
    button.ghost{background:transparent;border-color:#31407a}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:12px}
    .kpi .cell{background:#0b1230;border:1px dashed #27326b;border-radius:14px;padding:12px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #253063;padding:10px 8px;text-align:left;vertical-align:top}
    th{color:#b9c1d9;font-weight:600}
    details{border:1px solid #243268;background:#0e1636;border-radius:12px;padding:10px}
    summary{cursor:pointer}
    code.inline{background:#0b1230;border:1px solid #243268;border-radius:6px;padding:2px 6px}
    .hint{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)}.err{color:var(--err)}
  </style>
</head>
<body>
  <header>
    <h1>üè† Novalis ‚Äì Console admin minimale (lecture/√©criture)</h1>
    <div class="hint">Lis/√©cris dans <code class="inline">listings</code>, <code class="inline">messages</code>, <code class="inline">districts</code>, <code class="inline">pageviews</code>, <code class="inline">profiles</code>. RLS activ√©e.</div>
  </header>
  <main>
    <section class="card">
      <h2>Connexion Supabase</h2>
      <div class="row">
        <input id="sb-url" placeholder="SUPABASE_URL" style="min-width:280px" />
        <input id="sb-key" placeholder="SUPABASE_ANON_KEY" style="min-width:380px" />
        <button id="btn-bind" class="primary">Connecter</button>
        <span id="bind-status" class="muted"></span>
      </div>
      <details style="margin-top:8px"><summary>Astuce</summary>
        <div class="hint">Copie les valeurs depuis <em>Project Settings ‚Üí API</em>. Elles sont gard√©es en <code class="inline">localStorage</code>.</div>
      </details>
    </section>

    <section class="card">
      <h2>Authentification (requis pour lire <code class="inline">messages</code> et <code class="inline">profiles</code>)</h2>
      <div class="row">
        <input id="auth-email" placeholder="email" type="email" style="min-width:260px" />
        <input id="auth-pass" placeholder="mot de passe" type="password" style="min-width:200px" />
        <button id="btn-signin" class="primary">Se connecter</button>
        <button id="btn-signup" class="ghost">Cr√©er un compte</button>
        <button id="btn-signout" class="ghost">Se d√©connecter</button>
        <span id="auth-status" class="muted"></span>
      </div>
    </section>

    <section class="card">
      <h2>KPIs rapides</h2>
      <div class="kpi">
        <div class="cell"><div class="muted">Annonces</div><div id="kpi-listings" style="font-size:22px">‚Äì</div></div>
        <div class="cell"><div class="muted">Messages</div><div id="kpi-messages" style="font-size:22px">‚Äì</div></div>
        <div class="cell"><div class="muted">Quartiers</div><div id="kpi-districts" style="font-size:22px">‚Äì</div></div>
        <div class="cell"><div class="muted">Vues</div><div id="kpi-pageviews" style="font-size:22px">‚Äì</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btn-refresh-kpi" class="primary">Actualiser</button>
      </div>
    </section>

    <section class="card">
      <h2>Listings (lecture publique)</h2>
      <div class="row">
        <button id="btn-load-listings" class="primary">Charger</button>
      </div>
      <div id="tbl-listings" style="overflow:auto;margin-top:10px"></div>
    </section>

    <section class="card">
      <h2>Messages (auth requis pour lecture) & test d‚Äôinsertion</h2>
      <div class="row">
        <button id="btn-load-messages" class="primary">Charger</button>
        <span class="hint">Politique: <code class="inline">select</code> pour utilisateurs authentifi√©s, <code class="inline">insert</code> public.</span>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="m-listing" placeholder="listing_id" />
        <input id="m-from" placeholder="from_email" />
        <input id="m-text" placeholder="message..." style="min-width:260px" />
        <select id="m-via"><option value="site">site</option><option value="wa">wa</option><option value="email">email</option></select>
        <button id="btn-insert-message" class="ghost">Ins√©rer</button>
        <span id="msg-insert-status" class="muted"></span>
      </div>
      <div id="tbl-messages" style="overflow:auto;margin-top:10px"></div>
    </section>

    <section class="card">
      <h2>Districts (lecture publique, insertion auth)</h2>
      <div class="row">
        <button id="btn-load-districts" class="primary">Charger</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="d-city" placeholder="city" />
        <input id="d-district" placeholder="district" />
        <input id="d-lat" placeholder="lat" type="number" step="any" />
        <input id="d-lng" placeholder="lng" type="number" step="any" />
        <button id="btn-insert-district" class="ghost">Ins√©rer</button>
        <span id="dist-insert-status" class="muted"></span>
      </div>
      <div id="tbl-districts" style="overflow:auto;margin-top:10px"></div>
    </section>

    <section class="card">
      <h2>Pageviews (lecture/√©criture publique)</h2>
      <div class="row">
        <button id="btn-load-pageviews" class="primary">Charger</button>
        <input id="pv-path" placeholder="/route/exemple" />
        <button id="btn-insert-pageview" class="ghost">+1 vue</button>
        <span id="pv-status" class="muted"></span>
      </div>
      <div id="tbl-pageviews" style="overflow:auto;margin-top:10px"></div>
    </section>

    <section class="card">
      <h2>Outils</h2>
      <details>
        <summary>Uploader vers Storage (novalis-media)</summary>
        <div class="hint">Envoie un fichier dans <code class="inline">novalis-media</code> et renvoie l‚ÄôURL publique.</div>
        <div class="row" style="margin-top:8px">
          <input id="st-prefix" placeholder="prefix (ex: listings/tmp-123/photos)" style="min-width:320px" />
          <input id="st-file" type="file" />
          <button id="btn-storage-upload" class="ghost">Uploader</button>
          <span id="st-status" class="muted"></span>
        </div>
      </details>
    </section>
  </main>

  <script>
    let supabase = null;
    let sbUrl = localStorage.getItem('sb_url') || '';
    let sbKey = localStorage.getItem('sb_key') || '';

    const $ = (sel)=>document.querySelector(sel);

    $('#sb-url').value = sbUrl; $('#sb-key').value = sbKey;

    function bind(){
      sbUrl = $('#sb-url').value.trim();
      sbKey = $('#sb-key').value.trim();
      if(!sbUrl || !sbKey){ $('#bind-status').textContent = '‚Üí URL & KEY requis'; return; }
      supabase = window.supabase.createClient(sbUrl, sbKey);
      localStorage.setItem('sb_url', sbUrl); localStorage.setItem('sb_key', sbKey);
      $('#bind-status').innerHTML = 'Connect√©. <span class="ok">‚úî</span>';
    }

    $('#btn-bind').addEventListener('click', bind);
    if(sbUrl && sbKey){ bind(); }

    // ========== AUTH ==========
    async function showAuth(){
      const { data: { user } } = await supabase.auth.getUser();
      $('#auth-status').textContent = user ? `Connect√©: ${user.email}` : 'Non connect√©';
    }

    $('#btn-signin').addEventListener('click', async()=>{
      try{
        const email = $('#auth-email').value.trim();
        const password = $('#auth-pass').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if(error) throw error; $('#auth-status').innerHTML = 'Connect√©. <span class="ok">‚úî</span>';
      }catch(err){ $('#auth-status').innerHTML = `<span class="err">${err.message}</span>`; }
    });
    $('#btn-signup').addEventListener('click', async()=>{
      try{
        const email = $('#auth-email').value.trim();
        const password = $('#auth-pass').value;
        const { error } = await supabase.auth.signUp({ email, password });
        if(error) throw error; $('#auth-status').innerHTML = 'Compte cr√©√©. V√©rifie l\'email.';
      }catch(err){ $('#auth-status').innerHTML = `<span class="err">${err.message}</span>`; }
    });
    $('#btn-signout').addEventListener('click', async()=>{ await supabase.auth.signOut(); showAuth(); });

    // ========== KPIs ==========
    async function refreshKPI(){
      try{
        const [{count: c1},{count:c2},{count:c3},{count:c4}] = await Promise.all([
          supabase.from('listings').select('*', { count: 'exact', head: true }),
          supabase.from('messages').select('*', { count: 'exact', head: true }),
          supabase.from('districts').select('*', { count: 'exact', head: true }),
          supabase.from('pageviews').select('*', { count: 'exact', head: true }),
        ]);
        $('#kpi-listings').textContent = c1 ?? '‚Äì';
        $('#kpi-messages').textContent = c2 ?? '‚Äì';
        $('#kpi-districts').textContent = c3 ?? '‚Äì';
        $('#kpi-pageviews').textContent = c4 ?? '‚Äì';
      }catch(err){ console.error(err); }
    }
    $('#btn-refresh-kpi').addEventListener('click', refreshKPI);

    // ========== TABLE RENDER ==========
    function renderTable(el, rows){
      if(!rows || !rows.length){ el.innerHTML = '<div class="muted">(aucune donn√©e)</div>'; return; }
      const cols = Object.keys(rows[0]);
      let html = '<table><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
      for(const r of rows){ html += '<tr>' + cols.map(c=>`<td>${escapeHtml(JSON.stringify(r[c]))}</td>`).join('') + '</tr>'; }
      html += '</tbody></table>'; el.innerHTML = html;
    }
    function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }

    // ========== LISTINGS ==========
    $('#btn-load-listings').addEventListener('click', async()=>{
      const { data, error } = await supabase.from('listings').select('*').limit(200).order('created_at', { ascending:false });
      if(error){ $('#tbl-listings').innerHTML = `<span class=err>${error.message}</span>`; return; }
      renderTable($('#tbl-listings'), data);
    });

    // ========== MESSAGES ==========
    $('#btn-load-messages').addEventListener('click', async()=>{
      const { data, error } = await supabase.from('messages').select('*').limit(200).order('created_at', { ascending:false });
      if(error){ $('#tbl-messages').innerHTML = `<span class=err>${error.message}</span>`; return; }
      renderTable($('#tbl-messages'), data);
    });
    $('#btn-insert-message').addEventListener('click', async()=>{
      const row = {
        id: crypto.randomUUID(),
        listing_id: $('#m-listing').value.trim() || null,
        from_email: $('#m-from').value.trim() || null,
        text: $('#m-text').value.trim() || null,
        via: $('#m-via').value
      };
      const { error } = await supabase.from('messages').insert(row);
      $('#msg-insert-status').innerHTML = error ? `<span class=err>${error.message}</span>` : '<span class=ok>Ins√©r√© ‚úî</span>';
    });

    // ========== DISTRICTS ==========
    $('#btn-load-districts').addEventListener('click', async()=>{
      const { data, error } = await supabase.from('districts').select('*').limit(200).order('id', { ascending:false });
      if(error){ $('#tbl-districts').innerHTML = `<span class=err>${error.message}</span>`; return; }
      renderTable($('#tbl-districts'), data);
    });
    $('#btn-insert-district').addEventListener('click', async()=>{
      const row = {
        city: $('#d-city').value.trim() || null,
        district: $('#d-district').value.trim() || null,
        lat: parseFloat($('#d-lat').value) || null,
        lng: parseFloat($('#d-lng').value) || null,
      };
      const { error } = await supabase.from('districts').insert(row);
      $('#dist-insert-status').innerHTML = error ? `<span class=err>${error.message}</span>` : '<span class=ok>Ins√©r√© ‚úî</span>';
    });

    // ========== PAGEVIEWS ==========
    $('#btn-load-pageviews').addEventListener('click', async()=>{
      const { data, error } = await supabase.from('pageviews').select('*').limit(200).order('id', { ascending:false });
      if(error){ $('#tbl-pageviews').innerHTML = `<span class=err>${error.message}</span>`; return; }
      renderTable($('#tbl-pageviews'), data);
    });
    $('#btn-insert-pageview').addEventListener('click', async()=>{
      const row = { path: $('#pv-path').value.trim() || location.pathname };
      const { error } = await supabase.from('pageviews').insert(row);
      $('#pv-status').innerHTML = error ? `<span class=err>${error.message}</span>` : '<span class=ok>+1 ‚úî</span>';
    });

    // ========== STORAGE (novalis-media) ==========
    async function uploadToStorage(file, prefix){
      const bucket = 'novalis-media';
      const safeName = (file.name || 'file').normalize('NFKD').replace(/[^\w.-]+/g,'-').toLowerCase();
      const path = `${prefix}/${Date.now()}-${safeName}`;
      const { error } = await supabase.storage.from(bucket).upload(path, file, { cacheControl:'3600', upsert:false, contentType:file.type || 'application/octet-stream' });
      if(error) throw error;
      const { data } = supabase.storage.from(bucket).getPublicUrl(path);
      return data.publicUrl;
    }

    $('#btn-storage-upload').addEventListener('click', async()=>{
      try{
        const file = $('#st-file').files && $('#st-file').files[0];
        const prefix = $('#st-prefix').value.trim() || 'misc';
        if(!file){ $('#st-status').textContent = 'Choisis un fichier'; return; }
        const url = await uploadToStorage(file, prefix);
        $('#st-status').innerHTML = `URL: <a href="${url}" target="_blank">${url}</a>`;
      }catch(err){ $('#st-status').innerHTML = `<span class=err>${err.message}</span>`; }
    });

    // run once
    showAuth();
  </script>
</body>
</html>
