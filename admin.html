<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin ‚Äî NovalisHabitat.CI</title>
  <meta name="theme-color" content="#0f172a"/>

  <style>
    :root{
      --orange:#ff7f00;
      --green:#059669;
      --bd:#e5e7eb;
      --txt:#0f172a;
      --muted:#64748b;
      --bg:#f8fafc;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .head{padding:14px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
    .title{font-weight:800}
    .muted{color:var(--muted)}
    .body{padding:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    input,select,textarea,button{font:inherit}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:12px;background:#fff}
    button{padding:10px 14px;border:1px solid var(--bd);border-radius:12px;background:#fff;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--orange);border-color:var(--orange);color:#fff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab-btn{padding:8px 12px;border:1px solid var(--bd);border-radius:999px;background:#fff;cursor:pointer}
    .tab-btn.active{background:var(--green);border-color:transparent;color:#fff}
    .tab{display:none}
    .tab.active{display:block}
    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid var(--bd);text-align:left}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:16px 0}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--bd);border-radius:999px;background:#fff}
    .note{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;padding:10px 12px;border-radius:12px}
  </style>
</head>
<body>

<!-- üîê BARRAGE PAR MOT DE PASSE (anti-curieux) -->
<script>
(function(){
  const PASS = "novalis2025"; // ‚á¶ change ici si tu veux un autre mot de passe d‚Äôacc√®s √† admin.html
  const ask = prompt("Mot de passe Admin :");
  if (ask !== PASS){
    document.write("<!doctype html><title>Acc√®s refus√©</title><div style='font-family:sans-serif;max-width:680px;margin:80px auto;padding:0 16px'><h1>‚õî Acc√®s refus√©</h1><p>Cette page est prot√©g√©e.</p></div>");
    throw new Error("Blocked");
  }
})();
</script>

<div class="wrap">
  <div class="card">
    <div class="head">
      <div class="title">Admin ‚Äî NovalisHabitat.CI</div>
      <div class="muted" id="who">Non connect√©</div>
    </div>
    <div class="body">
      <!-- Connexion -->
      <div id="login-view">
        <div class="note" style="margin-bottom:12px">
          <b>Acc√®s restreint.</b> Connecte-toi avec un <u>compte Supabase</u> autoris√©.  
          (M√™me si quelqu‚Äôun trouve cette page, il restera bloqu√© sans authentification.)
        </div>
        <div class="grid">
          <div><label>Email</label><input id="email" type="email" placeholder="admin@exemple.com"/></div>
          <div><label>Mot de passe</label><input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btn-login" class="btn-primary">Se connecter</button>
          <button id="btn-signup">Cr√©er ce compte (si besoin)</button>
        </div>
      </div>

      <!-- Dashboard -->
      <div id="dash-view" style="display:none">
        <div class="topbar">
          <div class="tabs">
            <button class="tab-btn active" data-tab="t-profiles">Inscriptions</button>
            <button class="tab-btn" data-tab="t-listings">Annonces</button>
            <button class="tab-btn" data-tab="t-messages">Messages</button>
          </div>
          <div style="display:flex;gap:8px">
            <a href="./index.html" target="_blank" class="badge">‚Üó Ouvrir le site</a>
            <button id="btn-logout">D√©connexion</button>
          </div>
        </div>

        <div id="t-profiles" class="tab active">
          <div class="muted" style="margin-bottom:6px">Derni√®res inscriptions (lecture seule)</div>
          <div id="profiles-box">Chargement‚Ä¶</div>
        </div>

        <div id="t-listings" class="tab">
          <div class="muted" style="margin-bottom:6px">Derni√®res annonces (lecture/√©criture)</div>

          <form id="frm" class="grid" style="margin-bottom:12px">
            <div><label>Titre</label><input id="title" required/></div>
            <div><label>Type</label>
              <select id="type">
                <option value="vente">Vente</option>
                <option value="location">Location</option>
              </select>
            </div>
            <div><label>Cat√©gorie</label>
              <select id="kind">
                <option>villa</option><option>appartement</option><option>studio</option>
                <option>terrain</option><option>h√¥tel</option><option>bureau</option>
                <option>maison</option><option>duplex</option><option>immeuble</option><option>jardin</option>
              </select>
            </div>
            <div><label>Prix (FCFA)</label><input id="price" type="number" min="0" value="0"/></div>
            <div><label>Ville</label><input id="city" placeholder="Abidjan"/></div>
            <div><label>Quartier</label><input id="district" placeholder="Cocody"/></div>
            <div><label>Chambres</label><input id="bed" type="number" min="0" value="0"/></div>
            <div><label>Salle d‚Äôeau</label><input id="bath" type="number" min="0" value="0"/></div>
            <div><label>Surface (m¬≤)</label><input id="area" type="number" min="0" value="0"/></div>
            <div style="grid-column:1/-1"><label>Description</label><textarea id="desc" placeholder="D√©tails, proximit√©, commodit√©s‚Ä¶"></textarea></div>

            <div style="grid-column:1/-1" class="note">
              <b>Photos</b> ‚Äî colle des URLs s√©par√©es par des virgules (ou publie depuis le site <code>index.html</code> pour ajouter des fichiers locaux).
            </div>
            <div style="grid-column:1/-1"><label>Photos (URLs)</label><input id="photos" placeholder="https://‚Ä¶/1.jpg, https://‚Ä¶/2.jpg"/></div>

            <div><label>Latitude</label><input id="lat" type="number" step="any"/></div>
            <div><label>Longitude</label><input id="lng" type="number" step="any"/></div>

            <div><label>WhatsApp (E.164)</label><input id="whats" placeholder="+2250500000000"/></div>
            <div><label>Email contact</label><input id="emailContact" type="email" placeholder="proprietaire@exemple.com"/></div>

            <div style="grid-column:1/-1;display:flex;gap:8px">
              <button type="submit" class="btn-primary">Publier / Mettre √† jour</button>
              <button type="button" id="btn-clear">Effacer formulaire</button>
            </div>
          </form>

          <div id="listings-box">Chargement‚Ä¶</div>
        </div>

        <div id="t-messages" class="tab">
          <div class="muted" style="margin-bottom:6px">Messages re√ßus (site)</div>
          <div id="messages-box">Chargement‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Supabase -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ‚öôÔ∏è m√™me projet que ton index.html
  const SUPABASE_URL  = "https://qqznxwctxnenxxidaxrm.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxem54d2N0eG5lbnh4aWRheHJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODA0NDEsImV4cCI6MjA3MTE1NjQ0MX0.mIGXN4XYDyqULrqI1wekXb-xQTaHuYxqihRv9lI1ZiU";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);
  const $ = (s, r=document)=>r.querySelector(s);

  // UI helpers
  function setTab(id){
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelector(`.tab-btn[data-tab='${id}']`)?.classList.add("active");
    document.getElementById(id)?.classList.add("active");
  }
  document.querySelectorAll(".tab-btn").forEach(b=>b.addEventListener("click",()=>setTab(b.dataset.tab)));

  // Auth
  const loginView=$("#login-view"), dashView=$("#dash-view"), who=$("#who");
  $("#btn-login").addEventListener("click", async ()=>{
    const email=$("#email").value.trim();
    const password=$("#pass").value;
    if(!email||!password){ alert("Email et mot de passe requis."); return; }
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){ alert(error.message); return; }
  });
  $("#btn-signup").addEventListener("click", async ()=>{
    const email=$("#email").value.trim();
    const password=$("#pass").value;
    if(!email||!password){ alert("Email et mot de passe requis."); return; }
    const { error } = await supabase.auth.signUp({ email, password, options:{ data:{ role:"admin_candidate" } } });
    if(error){ alert(error.message); return; }
    alert("Compte cr√©√©. Valide l‚Äôemail puis connecte-toi.");
  });
  $("#btn-logout").addEventListener("click", async ()=>{
    await supabase.auth.signOut();
  });

  supabase.auth.onAuthStateChange((_e, session)=>{
    const user = session?.user || null;
    if(user){
      who.textContent = user.email || user.id;
      loginView.style.display="none";
      dashView.style.display="block";
      loadProfiles(); loadListings(); loadMessages();
    }else{
      who.textContent = "Non connect√©";
      dashView.style.display="none";
      loginView.style.display="block";
    }
  });
  (async()=>{ const { data:{ session } } = await supabase.auth.getSession(); const u=session?.user; if(u){ who.textContent=u.email||u.id; loginView.style.display="none"; dashView.style.display="block"; loadProfiles(); loadListings(); loadMessages(); }})();

  // Profiles
  async function loadProfiles(){
    try{
      const { data, error } = await supabase.from("profiles").select("id,prenom,nom,email,statut,created_at").order("created_at",{ascending:false}).limit(200);
      if(error) throw error;
      const rows = (data||[]).map(p=>`<tr><td>${p.prenom||""} ${p.nom||""}</td><td>${p.email||""}</td><td>${p.statut||""}</td><td>${(p.created_at||"").slice(0,19).replace("T"," ")}</td></tr>`).join("");
      $("#profiles-box").innerHTML = `<div style="overflow:auto"><table><thead><tr><th>Nom</th><th>Email</th><th>Statut</th><th>Cr√©√© le</th></tr></thead><tbody>${rows||"<tr><td colspan=4 class='muted'>‚Äî</td></tr>"}</tbody></table></div>`;
    }catch(e){ $("#profiles-box").innerHTML = `<div class="note">Impossible de charger (policies ?)</div>`; }
  }

  // Listings
  let CURRENT_EDIT_ID = null;
  $("#btn-clear").addEventListener("click",()=>{ CURRENT_EDIT_ID=null; $("#frm").reset(); });

  $("#frm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const item = {
      id: CURRENT_EDIT_ID || `P-${Date.now()}`,
      title: $("#title").value.trim(),
      type: $("#type").value,
      kind: $("#kind").value,
      price: Number($("#price").value)||0,
      city: $("#city").value.trim(),
      district: $("#district").value.trim(),
      bedrooms: Number($("#bed").value)||0,
      bathrooms: Number($("#bath").value)||0,
      area: Number($("#area").value)||0,
      lat: $("#lat").value? Number($("#lat").value) : null,
      lng: $("#lng").value? Number($("#lng").value) : null,
      desc: $("#desc").value.trim(),
      photos: ($("#photos").value||"").split(",").map(s=>s.trim()).filter(Boolean),
      contact_phone: $("#whats").value.trim(),
      contact_email: $("#emailContact").value.trim(),
      created_at: new Date().toISOString()
    };
    if(!item.title){ alert("Titre requis"); return; }
    try{
      const { error } = await supabase.from("listings").upsert(item);
      if(error) throw error;
      alert("Annonce enregistr√©e ‚úÖ");
      CURRENT_EDIT_ID=null; $("#frm").reset();
      loadListings();
    }catch(err){ alert("Erreur: "+err.message); }
  });

  async function loadListings(){
    try{
      const { data, error } = await supabase.from("listings")
        .select("id,title,city,district,price,type,kind,created_at")
        .order("created_at",{ascending:false}).limit(200);
      if(error) throw error;
      const rows = (data||[]).map(p=>`
        <tr>
          <td>${p.title||"-"}</td>
          <td>${p.city||"-"} ‚Ä¢ ${p.district||"-"}</td>
          <td>${(p.price||0).toLocaleString("fr-FR")} FCFA</td>
          <td>${p.type||"-"} / ${p.kind||"-"}</td>
          <td>${(p.created_at||"").slice(0,19).replace("T"," ")}</td>
          <td>
            <button data-id="${p.id}" class="btn-edit">√âditer</button>
            <button data-id="${p.id}" class="btn-del">Suppr.</button>
          </td>
        </tr>`).join("");
      $("#listings-box").innerHTML = `
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Titre</th><th>Lieu</th><th>Prix</th><th>Type/Cat√©gorie</th><th>Cr√©√© le</th><th>Actions</th></tr></thead>
            <tbody>${rows || "<tr><td colspan=6 class='muted'>‚Äî</td></tr>"}</tbody>
          </table>
        </div>`;

      // bind actions
      document.querySelectorAll(".btn-edit").forEach(b=>b.addEventListener("click",()=>editListing(b.dataset.id)));
      document.querySelectorAll(".btn-del").forEach(b=>b.addEventListener("click",()=>delListing(b.dataset.id)));
    }catch(e){ $("#listings-box").innerHTML = `<div class="note">Impossible de charger (policies ?)</div>`; }
  }
  async function editListing(id){
    try{
      const { data, error } = await supabase.from("listings").select("*").eq("id", id).single();
      if(error) throw error;
      const p = data;
      CURRENT_EDIT_ID = p.id;
      $("#title").value = p.title||"";
      $("#type").value = p.type||"vente";
      $("#kind").value = p.kind||"villa";
      $("#price").value = p.price||0;
      $("#city").value = p.city||"";
      $("#district").value = p.district||"";
      $("#bed").value = p.bedrooms||0;
      $("#bath").value = p.bathrooms||0;
      $("#area").value = p.area||0;
      $("#lat").value = p.lat||"";
      $("#lng").value = p.lng||"";
      $("#desc").value = p.desc||"";
      $("#photos").value = Array.isArray(p.photos)? p.photos.join(", ") : "";
      $("#whats").value = p.contact_phone||"";
      $("#emailContact").value = p.contact_email||"";
      setTab("t-listings");
      window.scrollTo({top:0,behavior:"smooth"});
    }catch(err){ alert("Erreur: "+err.message); }
  }
  async function delListing(id){
    if(!confirm("Supprimer cette annonce ?")) return;
    try{
      const { error } = await supabase.from("listings").delete().eq("id", id);
      if(error) throw error;
      loadListings();
    }catch(err){ alert("Erreur: "+err.message); }
  }

  // Messages
  async function loadMessages(){
    try{
      const { data, error } = await supabase.from("messages")
        .select("id,listing_id,from_email,text,via,created_at")
        .order("created_at",{ascending:false}).limit(300);
      if(error) throw error;
      const rows = (data||[]).map(m=>`
        <tr>
          <td>${m.id}</td>
          <td>${m.listing_id||"-"}</td>
          <td>${m.from_email||"-"}</td>
          <td>${(m.text||"").replace(/</g,"&lt;")}</td>
          <td>${(m.via||"").toUpperCase()}</td>
          <td>${(m.created_at||"").slice(0,19).replace("T"," ")}</td>
        </tr>`).join("");
      $("#messages-box").innerHTML = `
        <div style="overflow:auto">
          <table>
            <thead><tr><th>ID</th><th>Annonce</th><th>De</th><th>Texte</th><th>Canal</th><th>Date</th></tr></thead>
            <tbody>${rows || "<tr><td colspan=6 class='muted'>‚Äî</td></tr>"}</tbody>
          </table>
        </div>`;
    }catch(e){ $("#messages-box").innerHTML = `<div class="note">Impossible de charger (policies ?)</div>`; }
  }
</script>

</body>
</html>
