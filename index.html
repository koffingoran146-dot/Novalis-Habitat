<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NovalisHabitat.CI</title>
  <meta name="theme-color" content="#ff7f00"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <style>
    :root{
      --orange:#ff7f00;
      --green:#10b981;
      --greenPure:#087834;   /* contour vert fonc√© (style drapeau) */
      --greenBadgeBg:#bdf7cf;/* fond vert clair lisible */
      --txt:#0f172a;--muted:#6b7280;--bd:#e5e7eb;--bg:#FFF4E6
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    a{color:#0ea5e9;text-decoration:none}
    .header{position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid var(--bd)}
    .container{max-width:1200px;margin:0 auto;padding:12px 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:900;display:flex;align-items:center;gap:6px;cursor:pointer}
    .dot{position:relative;width:12px;height:12px;border-radius:999px;display:inline-block;margin-left:6px}
    .o{background:#ff7f00}.w{background:#e5e7eb;border:1px solid #d1d5db}.g{background:#10b981}
    .count{position:absolute;top:-10px;right:-12px;background:#0f1530;color:#fff;border-radius:999px;padding:0 6px;font-size:10px;line-height:16px;min-width:18px;text-align:center}
    .spacer{flex:1}
    .btn{border:1px solid var(--bd);border-radius:12px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:600}
    .btn:hover{transform:translateY(-1px)}
    .btn.install{background:var(--orange);border-color:var(--orange);color:#fff}
    .pill{border:1px solid var(--bd);border-radius:999px;padding:6px 12px;background:#fff;cursor:pointer}
    .pill.active{background:var(--green);color:#fff;border-color:transparent}
    input,select,textarea{border:1px solid var(--bd);border-radius:12px;padding:8px 12px;background:#fff;font-size:14px}
    select.compact{padding:6px 10px;height:36px}
    textarea{min-height:80px;resize:vertical}
    .muted{color:var(--muted)}
    #fiche{max-width:1100px;margin:14px auto 0;padding:16px;border:1px solid #111a38;border-radius:14px;background:#0f1530;color:#e9eefb;display:none}
    #pdf-bar{max-width:1100px;margin:8px auto 0;display:none;gap:8px}
    #alert-login{position:fixed;left:16px;bottom:16px;background:#0f1530;color:#e9eefb;border:1px solid #111a38;border-radius:12px;padding:8px 12px;z-index:40;display:none}
    /* GPS masqu√© par d√©faut */
    #map{max-width:1200px;margin:16px auto;border:1px solid var(--bd);border-radius:12px;background:#fff;padding:10px;display:none}
    #leaf{height:520px;border-radius:12px;overflow:hidden}
    .grid{max-width:1200px;margin:0 auto 80px;display:grid;gap:16px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{border:1px solid var(--bd);border-radius:16px;overflow:hidden;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .cover-box{width:100%;aspect-ratio:16/9;background:#e5e7eb;position:relative;overflow:hidden}
    .cover{width:100%;height:100%;object-fit:cover;display:block}
    .inner{padding:12px}
    .badge{display:inline-flex;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;font-size:12px;gap:6px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:10px;z-index:65}
    .modal.open{display:flex}
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .dialog{position:relative;z-index:1;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);max-width:980px;width:100%;max-height:92vh;display:flex;flex-direction:column}
    .dialog .head{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:12px}
    .dialog .body{padding:12px;overflow:auto}
    .dialog .grid2{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:640px){.dialog .grid2{grid-template-columns:1fr 1fr}}
    .account-wrap{position:relative}
    .popover{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);width:320px;display:none;z-index:70}
    .popover.open{display:block}
    .pop-title{font-weight:700;margin-bottom:6px}
    .pop-row{display:flex;gap:8px;align-items:center}
    .pop-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--bd);z-index:10}
    .foot{max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px}
    .foot-center{margin-left:auto;color:#334155;font-weight:600}
    #bot-button{position:fixed;right:16px;bottom:86px;width:56px;height:56px;border-radius:999px;background:linear-gradient(135deg,#ff7f00,#10b981);display:flex;align-items:center;justify-content:center;color:#fff;font-size:26px;border:none;box-shadow:0 12px 28px rgba(0,0,0,.22);cursor:pointer;z-index:9999}
    #bot-panel{position:fixed;right:16px;bottom:150px;width:360px;max-width:95vw;max-height:70vh;background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.22);display:none;flex-direction:column;overflow:hidden;z-index:9999}
    #bot-panel.open{display:flex}
    .bot-head{padding:10px 12px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center}
    .bot-body{padding:12px;overflow:auto;flex:1}
    .bot-msg{margin-bottom:10px}
    .bot-msg.me{text-align:right}
    .bot-msg .bubble{display:inline-block;padding:8px 10px;border-radius:12px;border:1px solid var(--bd);background:#fff;max-width:87%}
    .bot-msg.me .bubble{background:#0f1530;color:#e9eefb;border-color:#111a38}
    .bot-input{display:flex;gap:8px;border-top:1px solid var(--bd);padding:10px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{border:1px solid var(--bd);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-size:13px}
  </style>
</head>
<body>
  <div id="alert-login">Connexion requise</div>

  <div id="pdf-bar" class="container">
    <button id="btnPdf" class="btn">T√©l√©charger ma fiche (PDF)</button>
  </div>
  <section id="fiche">
    <h2>Ma fiche</h2>
    <p>Nom : <span id="fiche-nom">-</span></p>
    <p>Email : <span id="fiche-email">-</span></p>
  </section>

  <div class="header">
    <div class="container toolbar">
      <div id="brand" class="brand" title="Accueil">
        <span style="color:#ff7f00">Novalis</span><span style="color:#0f172a">Habitat</span><span style="color:#10b981">.CI</span>
        <span class="dot o" title="Annonces"><span id="n-orange" class="count">0</span></span>
        <span class="dot w" title="Vues"><span id="n-white" class="count">0</span></span>
        <span class="dot g" title="Favoris"><span id="n-green" class="count">0</span></span>
      </div>
      <div class="spacer"></div>

      <!-- S√©lecteur regroup√© des types de biens (avant Explorer) -->
      <select id="kind-filter" class="compact" title="Maisons / Appartements">
        <option value="">Biens : Tous</option>
        <option value="appartement">Appartements</option>
        <option value="maison">Maisons</option>
        <option value="villa">Villas</option>
        <option value="studio">Studios</option>
        <option value="terrain">Terrains</option>
        <option value="bureau">Bureaux</option>
        <option value="duplex">Duplex</option>
        <option value="immeuble">Immeubles</option>
        <option value="h√¥tel">H√¥tels</option>
        <option value="hotel">H√¥tels (alt)</option>
        <option value="jardin">Jardin</option>
      </select>

      <button id="btn-explore" class="btn">Explorer</button>
      <button id="btn-gps" class="btn">Localisation</button>
      <button id="btn-abonnement" class="btn">Inscription</button>
      <button id="btn-install" class="btn install">Installer</button>
      <button id="btn-dash" class="btn">Tableau de bord</button>

      <div class="account-wrap">
        <button id="btn-account" class="btn">Compte</button>
        <div id="login-pop" class="popover">
          <div class="pop-title">Connexion</div>
          <div class="pop-row"><input id="nh-email" type="email" placeholder="Email"/></div>
          <div class="pop-row"><input id="nh-password" type="password" placeholder="Mot de passe"/></div>
          <div class="pop-actions">
            <button class="btn" id="btn-pop-in">Se connecter</button>
            <button class="btn install" id="btn-pop-up">Cr√©er un compte</button>
          </div>
          <div id="after-login" style="display:none">
            <div class="muted" style="margin-top:6px">Connect√© : <b id="nh-who"></b></div>
            <div class="pop-actions" style="justify-content:flex-start;margin-top:6px">
              <button class="btn" id="btn-pop-pdf">Imprimer ma fiche</button>
              <button class="btn" id="btn-pop-out">Se d√©connecter</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container toolbar" style="margin-top:12px">
    <button class="pill active" data-mode="all">Tout</button>
    <button class="pill" data-mode="vente">√Ä vendre</button>
    <button class="pill" data-mode="location">√Ä louer</button>

    <select id="city-filter"><option value="">Ville</option></select>
    <select id="district-filter" disabled><option value="">Quartier</option></select>

    <input type="number" id="max-price" placeholder="Budget max (FCFA)" min="0"/>
    <button id="apply-filters" class="btn">Filtrer</button>
    <button id="btn-near-filter" class="btn">Pr√®s de moi</button>
    <select id="bedrooms">
      <option value="">Chambres (min)</option><option value="0">Studio</option><option value="1">1+</option><option value="2">2+</option><option value="3">3+</option><option value="4">4+</option>
    </select>

    <span class="spacer"></span>
    <input id="search" placeholder="Rechercher‚Ä¶" style="min-width:220px"/>
    <button id="btn-search" class="btn">Rechercher</button>
    <select id="sort-by"><option value="recent">Tri: R√©cent</option><option value="price-asc">Tri: Prix ‚Üë</option><option value="price-desc">Tri: Prix ‚Üì</option><option value="area">Tri: Surface</option></select>
    <button id="btn-publish" class="btn">Cr√©er une annonce</button>
  </div>

  <!-- SECTION CARTE (masqu√©e par d√©faut) -->
  <section id="map" class="container">
    <div style="font-weight:700;margin-bottom:6px">Carte & GPS ‚Äî C√¥te d‚ÄôIvoire</div>
    <div class="toolbar" style="gap:8px;margin:8px 0">
      <button id="btn-ci" class="btn">Vue C√¥te d‚ÄôIvoire</button>
      <button id="btn-near" class="btn">Autour de moi</button>
      <button id="btn-hide-map" class="btn">Masquer la carte</button>
    </div>
    <div id="leaf"></div>
  </section>

  <main class="container">
    <div id="grid" class="grid" style="padding-bottom:60px"></div>
    <div id="empty" class="muted" style="text-align:center;padding:48px 0;display:none">Aucun r√©sultat. <button class="btn" id="reset-filters">R√©initialiser</button> ‚ú®</div>
  </main>

  <div id="modal" class="modal">
    <div class="overlay" id="overlay"></div>
    <div class="dialog">
      <div class="head toolbar" style="justify-content:space-between">
        <div style="font-weight:700" id="m-title"></div>
        <div class="toolbar">
          <button class="btn" id="m-share">Partager</button>
          <button class="btn" id="m-fav">‚òÜ Favori</button>
          <button class="btn" id="m-close">Fermer</button>
        </div>
      </div>
      <div class="body">
        <div id="m-geo" class="muted"></div>
        <div id="m-specs" class="muted"></div>
        <div style="font-size:18px;font-weight:700" id="m-price"></div>
        <p id="m-desc" class="muted"></p>

        <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--bd)">
          <div style="font-weight:700;margin-bottom:6px">Contacter le propri√©taire</div>
          <textarea id="m-msg" placeholder="Je suis int√©ress√©." style="margin-bottom:8px">Je suis int√©ress√©.</textarea>
          <div class="toolbar">
            <button class="btn" id="m-msg-wa">Envoyer via WhatsApp</button>
            <button class="btn" id="m-msg-mail">Envoyer par e-mail</button>
            <button class="btn install" id="m-msg-site">Message priv√© (site)</button>
            <button class="btn" id="m-devis-wa" style="display:none">Demander un devis (WhatsApp)</button>
          </div>
          <div class="muted" id="m-contact-hint"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="insc-modal" class="modal">
    <div class="overlay" data-close="#insc-modal"></div>
    <div class="dialog">
      <div class="head">
        <div class="toolbar" style="justify-content:space-between">
          <strong>Inscription</strong>
          <button class="btn" data-close="#insc-modal">Fermer</button>
        </div>
      </div>
      <div class="body">
        <form id="insc-form" class="grid2">
          <div><label>Nom</label><input id="f-nom" required/></div>
          <div><label>Pr√©nom</label><input id="f-prenom" required/></div>
          <div><label>Date de naissance</label><input id="f-dnaiss" type="date" required/></div>
          <div><label>Lieu de naissance</label><input id="f-lnaiss" required/></div>
          <div class="grid2" style="grid-template-columns:2fr 1fr">
            <div><label>Adresse</label><input id="f-adresse"/></div>
            <div><label>Titre / Fonction</label><input id="f-titre" placeholder="√âtudiant, Particulier, Client‚Ä¶"/></div>
          </div>
          <div class="grid2" style="grid-template-columns:2fr 1fr">
            <div><label>Email (identifiant)</label><input id="f-email" type="email" required/></div>
            <div><label>Mot de passe</label><input id="f-pass" type="password" minlength="6" required/></div>
          </div>
          <div>
            <label>Statut</label>
            <select id="f-statut" required>
              <option value="">‚Äî Choisir ‚Äî</option>
              <option>√âtudiant</option><option>Particulier</option><option>Client</option>
            </select>
          </div>
          <div><button class="btn install" type="submit">Cr√©er mon compte</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Tableau de bord -->
  <div id="dash-modal" class="modal">
    <div class="overlay" data-close="#dash-modal"></div>
    <div class="dialog">
      <div class="head">
        <div class="toolbar" style="justify-content:space-between">
          <strong>Tableau de bord</strong>
          <div class="toolbar" style="gap:6px">
            <button class="btn" data-tab="tab-profiles">Inscriptions</button>
            <button class="btn" data-tab="tab-mylistings">Mes annonces</button>
            <button class="btn" data-tab="tab-messages">Messages</button>
            <button class="btn" data-close="#dash-modal">Fermer</button>
          </div>
        </div>
      </div>
      <div class="body">
        <div id="tab-profiles" class="tab">Chargement‚Ä¶</div>
        <div id="tab-mylistings" class="tab" style="display:none">‚Äî</div>
        <div id="tab-messages" class="tab" style="display:none">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Bot -->
  <button id="bot-button" title="Assistant">üí¨</button>
  <div id="bot-panel" aria-live="polite">
    <div class="bot-head">
      <strong>Assistant NovalisHabitat</strong>
      <button class="btn" id="bot-close">Fermer</button>
    </div>
    <div class="bot-body" id="bot-body"></div>
    <div class="bot-input">
      <input id="bot-text" placeholder="Posez votre question‚Ä¶"/>
      <button class="btn" id="bot-send">Envoyer</button>
    </div>
  </div>

  <footer>
    <div class="foot">
      <a href="#" id="f-explore" class="link">Explorer</a> |
      <a href="#" id="f-gps" class="link">Localisation</a> |
      <a href="#" id="f-contact" class="link">Contact</a>
      <div class="foot-center">¬© 2025 NovalisHabitat.CI ‚Äî Abidjan, C√¥te d‚ÄôIvoire</div>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ‚Äî‚Äî‚Äî‚Äî‚Äî √Ä RENSEIGNER SI TU ACTIVES SUPABASE ‚Äî‚Äî‚Äî‚Äî‚Äî
    const SUPABASE_URL  = "https://TON-PROJET.supabase.co";
    const SUPABASE_ANON = "ta_cle_anon_publique";
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

    const ADMIN_PHONE_E164 = "+2250700435569";  // WhatsApp principal
    const ADMIN_TELEGRAM   = "";
    const ADMIN_EMAIL      = "claudbrou01@gmail.com";

    // Jardin / Les Fleurs d‚ÄôEden
    const ADMIN_PAYSAGISTE_NAME  = "Les Fleurs d‚ÄôEden";
    const ADMIN_PAYSAGISTE_PHONE = "+2250700435569";
    const ADMIN_PAYSAGISTE_EMAIL = "claudbrou01@gmail.com";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const $=(s,r=document)=>r.querySelector(s), qsa=(s,r=document)=>Array.from(r.querySelectorAll(s)), fmt=n=>(n||0).toLocaleString("fr-FR");
    const LS_LISTINGS="nh:listings", LS_FAVS="nh:favs", LS_PENDING_PROFILE="nh:pending-profile", LS_MSG="nh:messages", LS_VIEWS="nh:views", LS_DIST="nh:custom-districts";

    const REAL={
      villa:["https://source.unsplash.com/1024x640/?villa,house,modern,africa&sig=11"],
      appartement:["https://source.unsplash.com/1024x640/?apartment,interior&sig=21"],
      hotel:["https://source.unsplash.com/1024x640/?hotel,lagoon,water&sig=31"],
      studio:["https://source.unsplash.com/1024x640/?studio,apartment,small&sig=41"],
      terrain:["https://source.unsplash.com/1024x640/?land,plot,field,africa&sig=51"],
      jardin:["https://source.unsplash.com/1024x640/?garden,landscape,plants,africa&sig=61"]
    };

    // D√©mo locale (fusionne avec ce que l‚Äôutilisateur publie)
    const SAMPLE=[
      {id:"P-JARDIN",title:`Paysagiste ‚Äî ${ADMIN_PAYSAGISTE_NAME}`,type:"location",kind:"jardin",price:0,city:"Abidjan",district:"Cocody",bedrooms:0,bathrooms:0,area:0,lat:5.356,lng:-3.990,photos:REAL.jardin,created_at:"2025-07-15T09:30:00Z",contact_phone:ADMIN_PAYSAGISTE_PHONE,contact_email:ADMIN_PAYSAGISTE_EMAIL},
      {id:"P-002",title:"Villa moderne avec piscine ‚Äî Cocody",type:"vente",kind:"villa",price:29000000,city:"Abidjan",district:"Cocody",bedrooms:4,bathrooms:3,area:220,lat:5.356,lng:-3.990,photos:REAL.villa,created_at:"2025-06-30T10:00:00Z",contact_phone:ADMIN_PHONE_E164,contact_email:ADMIN_EMAIL},
      {id:"P-001",title:"Appartement 3 pi√®ces ‚Äî Bouak√©",type:"location",kind:"appartement",price:35000,city:"Bouak√©",district:"Belleville",bedrooms:2,bathrooms:1,area:68,lat:7.690,lng:-5.030,photos:REAL.appartement,created_at:"2025-07-02T09:00:00Z",contact_phone:ADMIN_PHONE_E164,contact_email:ADMIN_EMAIL}
    ];

    function db_get(k,def){try{return JSON.parse(localStorage.getItem(k))??def}catch{ return def }}
    function db_set(k,v){localStorage.setItem(k,JSON.stringify(v))}

    const CI_CITIES_BASE={
      "Abidjan":["Plateau","Cocody","Yopougon","Abobo","Marcory","Treichville","Koumassi","Port-Bou√´t","Adjam√©","Att√©coub√©","Bingerville","Anyama"],
      "Bouak√©":["Koko","Air France","Dar-Es-Salam","Belleville"],
      "Yamoussoukro":["Morof√©","Assabou","Millionnaire"],
      "San-P√©dro":["Bardot","Balmer","Sogb√¥"],
      "Korhogo":["Haoussabougou","Sinistr√©"],
      "Daloa":["Kennedy","Abattoir"],
      "Man":["Grand-Gbapleu","Libreville"],
      "Gagnoa":["Garahio","Dioulabougou"],
      "Divo":["Plateau","8e Tranche"],
      "Abengourou":["Koumassi","Sogefia"],
      "Bondoukou":["Sokoro","Zanzan"],
      "Odienn√©":["Sogban","Kakologo"]
    };
    function getCustomDistricts(){return db_get(LS_DIST,{})}
    function saveCustomDistricts(d){db_set(LS_DIST,d)}
    function getCities(){const custom=getCustomDistricts();const merged=JSON.parse(JSON.stringify(CI_CITIES_BASE));Object.keys(custom).forEach(c=>{merged[c]=Array.from(new Set([...(merged[c]||[]),...custom[c]]))});return merged}
    let CI_CITIES=getCities();

    function loadListings(){const local=db_get(LS_LISTINGS,[]);const map={};[...SAMPLE,...local].forEach(x=>map[x.id]=x);return Object.values(map)}
    function saveListing(list){const arr=db_get(LS_LISTINGS,[]).filter(x=>x.id!==list.id);arr.push(list);db_set(LS_LISTINGS,arr)}

    let STATE={listings:loadListings(),favs:new Set(db_get(LS_FAVS,[])),mode:"all",city:"",district:"",maxPrice:"",bedrooms:"",query:"",sortBy:"recent",kind:""};
    const TYPES=["appartement","villa","studio","terrain","bureau","maison","duplex","immeuble","h√¥tel","hotel","jardin"];
    function icon(kind){const k=(kind||"").toLowerCase(); if(k==="h√¥tel"||k==="hotel") return "üè®"; if(k==="terrain") return "üåç"; if(k==="villa") return "üè°"; if(k==="studio") return "üõèÔ∏è"; if(k==="appartement") return "üè¢"; if(k==="jardin") return "üåø"; return "üè†";}
    const waLink = ADMIN_PHONE_E164 ? ("https://wa.me/" + ADMIN_PHONE_E164.replace(/[+ ]/g,"")) : "";

    // helpers
    function openModal(sel){const el=$(sel); if(!el) return; el.classList.add("open"); $("#alert-login").style.display="none"}
    function closeModal(sel){const el=$(sel); if(!el) return; el.classList.remove("open")}

    // compteurs
    function refreshCounters(){
      $("#n-orange").textContent = loadListings().length;
      $("#n-white").textContent  = db_get(LS_VIEWS,0);
      $("#n-green").textContent  = db_get(LS_FAVS,[]).length;
    }
    db_set(LS_VIEWS, (db_get(LS_VIEWS,0)+1));
    refreshCounters();
    (async ()=>{ try{ await supabase.from("pageviews").insert({ path: location.pathname }); }catch{} })();

    // header actions
    $("#brand").addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"});render();});
    $("#btn-explore").addEventListener("click",()=>{$("#grid").scrollIntoView({behavior:"smooth"}); hideMap();});
    function showMap(){ const sec=$("#map"); sec.style.display="block"; initMap(true); sec.scrollIntoView({behavior:"smooth"}); }
    function hideMap(){ const sec=$("#map"); sec.style.display="none"; }
    $("#btn-gps").addEventListener("click",()=>{showMap()});
    $("#btn-abonnement").addEventListener("click",()=>openModal("#insc-modal"));
    $("#btn-dash").addEventListener("click",()=>{openModal("#dash-modal"); loadDashboard()});
    $("#btn-hide-map").addEventListener("click",()=>hideMap());

    // login popover
    const pop=$("#login-pop"), btnAcc=$("#btn-account");
    btnAcc.addEventListener("click",()=>pop.classList.toggle("open"));
    document.addEventListener("click",(e)=>{if(!pop.contains(e.target) && !btnAcc.contains(e.target)) pop.classList.remove("open")});
    $("#btn-pop-in").addEventListener("click", async ()=>{
      const email=$("#nh-email").value, password=$("#nh-password").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) alert(error.message);
    });
    $("#btn-pop-up").addEventListener("click",()=>{pop.classList.remove("open"); openModal("#insc-modal")});
    $("#btn-pop-pdf").addEventListener("click",()=>$("#btnPdf").click());
    $("#btn-pop-out").addEventListener("click", async ()=>{ await supabase.auth.signOut(); });

    // install PWA
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e});
    $("#btn-install").addEventListener("click",async()=>{if(deferredPrompt){deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null}else alert("Astuce: utilise ¬´ Ajouter √† l‚Äô√©cran d‚Äôaccueil ¬ª.")});

    // filtres (ville/quartier/etc.)
    const citySel=$("#city-filter"), distSel=$("#district-filter");
    function refreshCitySelect(select,withEmpty=true){select.innerHTML=withEmpty?'<option value="">Ville</option>':"";Object.keys(CI_CITIES).forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;select.appendChild(o)})}
    function refreshDistrictSelect(select,city,withEmpty=true){select.innerHTML=withEmpty?'<option value="">Quartier</option>':"";(CI_CITIES[city]||[]).forEach(d=>{const o=document.createElement("option");o.value=d;o.textContent=d;select.appendChild(o)});select.disabled=!city}
    refreshCitySelect(citySel); distSel.disabled=true;
    citySel.addEventListener("change",()=>{STATE.city=citySel.value;STATE.district="";refreshDistrictSelect(distSel,STATE.city)});
    distSel.addEventListener("change",()=>{STATE.district=distSel.value});
    $("#bedrooms").addEventListener("change",e=>{STATE.bedrooms=e.target.value;render(); if($("#map").style.display!=="none") initMap(true)});
    $("#max-price").addEventListener("input",e=>{STATE.maxPrice=e.target.value});

    // mode (tout/vente/location)
    qsa(".pill[data-mode]").forEach(b=>b.addEventListener("click",()=>{qsa(".pill[data-mode]").forEach(x=>x.classList.remove("active"));b.classList.add("active");STATE.mode=b.dataset.mode;render(); if($("#map").style.display!=="none") initMap(true)}));

    // recherche + tri
    $("#search").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();render(); if($("#map").style.display!=="none") initMap(true)}});
    $("#btn-search").addEventListener("click",()=>{render(); if($("#map").style.display!=="none") initMap(true)});
    $("#sort-by").addEventListener("change",e=>{STATE.sortBy=e.target.value;render()});

    // S√©lecteur regroup√© des types
    const kindSel=$("#kind-filter");
    kindSel.addEventListener("change",()=>{STATE.kind=kindSel.value||""; render(); if($("#map").style.display!=="none") initMap(true)});

    $("#apply-filters").addEventListener("click",()=>{render(); if($("#map").style.display!=="none") initMap(true)});
    $("#reset-filters").addEventListener("click",()=>{
      STATE={...STATE,mode:"all",city:"",district:"",maxPrice:"",bedrooms:"",query:"",sortBy:"recent",kind:""};
      citySel.value=""; refreshDistrictSelect(distSel,""); kindSel.value="";
      qsa(".pill[data-mode]").forEach(x=>x.classList.remove("active")); qsa(".pill[data-mode]")[0].classList.add("active");
      render(); if($("#map").style.display!=="none") initMap(true)
    });

    // ======== PIN STYLE "GPS" : fl√®che qui pointe + prix dedans ========
    let map=null, layer=null, bboxCI=[[4.0,-8.6],[10.7,-2.5]];
    function markerIcon(kind, price){
      const isJardin = String(kind||"").toLowerCase()==="jardin";
      const label = isJardin ? "Paysagiste" : (fmt(price) + " FCFA");

      const paddingX = 14, charW = 7, rectH = 26, tipH = 10, r = 12;
      const w = Math.max(90, label.length * charW + paddingX*2);
      const h = rectH + tipH;

      const css = getComputedStyle(document.documentElement);
      const bg   = css.getPropertyValue('--greenBadgeBg').trim() || '#bdf7cf';
      const line = css.getPropertyValue('--greenPure').trim()     || '#087834';
      const txt  = '#111';

      const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
        <rect x="0.5" y="0.5" width="${w-1}" height="${rectH-1}" rx="${r}" ry="${r}"
              fill="${bg}" stroke="${line}" stroke-width="1"/>
        <path d="M ${(w/2)-8} ${rectH-1} L ${w/2} ${h-0.5} L ${(w/2)+8} ${rectH-1} Z"
              fill="${bg}" stroke="${line}" stroke-width="1" />
        <text x="${w/2}" y="${(rectH/2)+5}" text-anchor="middle" font-weight="800" font-size="12" fill="${txt}">${label}</text>
      </svg>`;

      return L.divIcon({
        className: "",
        html: svg,
        iconSize: [w, h],
        iconAnchor: [w/2, h] // la pointe ‚Äúpique‚Äù la position exacte
      });
    }

    function toRad(x){return x*Math.PI/180}
    function haversine(lat1,lon1,lat2,lon2){
      const R=6371, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    function filteredListings(){
      const max=Number($("#max-price").value||0);
      const q=($("#search").value||"").toLowerCase();
      return (STATE.listings||[])
        .filter(p=>[p.title,p.city,p.district,(p.kind||"")].join(" ").toLowerCase().includes(q))
        .filter(p=>(STATE.mode==="all"?true:p.type===STATE.mode))
        .filter(p=>(max? p.price<=max:true))
        .filter(p=>(STATE.city? p.city===STATE.city:true))
        .filter(p=>(STATE.district? p.district===STATE.district:true))
        .filter(p=>(STATE.bedrooms!==""?(p.bedrooms||0)>=Number(STATE.bedrooms):true))
        .filter(p=>{ if(!STATE.kind) return true; const k=String(p.kind||"").toLowerCase(); return k===STATE.kind || (STATE.kind==="h√¥tel" && k==="hotel"); });
    }

    function initMap(force=false){
      if(!map){map=L.map('leaf',{zoomControl:true,attributionControl:true});map.fitBounds(bboxCI);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map)}
      if(layer){layer.remove()}
      const fl=filteredListings();
      const markers=fl.filter(p=>p.lat&&p.lng).map(p=>{
        const m=L.marker([p.lat,p.lng],{icon:markerIcon(p.kind,p.price)})
          .on('click',()=>{ hideMap(); openDetail(p.id); document.getElementById('grid').scrollIntoView({behavior:'smooth'}); })
          .bindPopup(`
            <b><a href="#" onclick="hideMap();openDetail('${p.id}');document.getElementById('grid').scrollIntoView({behavior:'smooth'});return false;">${p.title}</a></b><br>
            ${p.city} ‚Ä¢ ${p.district}<br>
            <a href="#" onclick="hideMap();openDetail('${p.id}');document.getElementById('grid').scrollIntoView({behavior:'smooth'});return false;">
              <span style="display:inline-block;margin-top:4px;background:var(--greenBadgeBg);color:#111;padding:2px 6px;border:1px solid var(--greenPure);border-radius:6px">${fmt(p.price)} Franc CFA</span>
            </a>
          `);
        return m;
      });
      layer=L.layerGroup(markers).addTo(map);
      if(markers.length){try{const group=L.featureGroup(markers);map.fitBounds(group.getBounds(),{padding:[24,24]})}catch{map.fitBounds(bboxCI)}}else{map.fitBounds(bboxCI)}
    }

    $("#btn-ci").addEventListener("click",()=>{ if(!map){initMap(true)}; map.fitBounds(bboxCI)});
    $("#btn-near").addEventListener("click",()=>{showMap(); if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{if(!map){initMap(true)}; map.setView([pos.coords.latitude,pos.coords.longitude],13)},()=>alert("Impossible d‚Äôobtenir la position"))}else alert("GPS non disponible")});
    $("#btn-near-filter").addEventListener("click",()=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          STATE.listings = loadListings().filter(p=>p.lat&&p.lng && haversine(pos.coords.latitude,pos.coords.longitude,p.lat,p.lng)<=10);
          render(); showMap(); initMap(true);
        },()=>alert("Impossible d‚Äôobtenir votre position"));
      } else alert("GPS non disponible");
    });

    // LISTE + D√âTAIL
    function openDetail(id){
      const p=STATE.listings.find(x=>x.id===id); if(!p) return;
      $("#m-title").textContent=`${icon(p.kind)} ${p.title}`;
      const isHotel=(String(p.kind||"").toLowerCase().includes("h√¥tel")||String(p.kind||"").toLowerCase().includes("hotel"));
      const isJardin=(String(p.kind||"").toLowerCase()==="jardin");

      $("#m-price").innerHTML = isJardin
        ? `<span class="muted">Service paysagiste</span>`
        : `<span style="background:var(--greenBadgeBg);color:#111;padding:2px 6px;border:1px solid var(--greenPure);border-radius:6px">
             ${fmt(p.price)} FCFA${p.type==="location" ? ` / ${isHotel?"nuit":"mois"}` : ""}
           </span>`;

      $("#m-geo").textContent=`${p.city} ‚Ä¢ ${p.district}`;
      $("#m-specs").textContent=`${p.bedrooms||0} ch ‚Ä¢ ${p.bathrooms||0} sdb ‚Ä¢ ${p.area||0} m¬≤`;
      $("#m-desc").textContent = isJardin ? "Cr√©ation et entretien de jardins √† domicile. Contactez Les Fleurs d‚ÄôEden pour un devis." : "Contactez-nous pour plus d‚Äôinformations.";

      const favBtn=$("#m-fav"); favBtn.textContent=STATE.favs.has(p.id)?"‚òÖ Favori":"‚òÜ Favori";
      favBtn.onclick=()=>{ if(STATE.favs.has(p.id)) STATE.favs.delete(p.id); else STATE.favs.add(p.id); db_set(LS_FAVS,[...STATE.favs]); render(); favBtn.textContent=STATE.favs.has(p.id)?"‚òÖ Favori":"‚òÜ Favori"; refreshCounters(); };

      const hint=[]; if(p.contact_phone) hint.push("WhatsApp"); if(p.contact_email) hint.push("Email");
      $("#m-contact-hint").textContent = "Contact dispo : "+ (hint.join(" / ") || "admin");

      const msg=()=>($("#m-msg").value||"Je suis int√©ress√©.");
      $("#m-msg-wa").onclick=()=>{ const phone=(p.contact_phone||ADMIN_PAYSAGISTE_PHONE||ADMIN_PHONE_E164||"").replace(/[+ ]/g,""); if(!phone) return alert("Num√©ro WhatsApp non configur√©."); const url=`https://wa.me/${phone}?text=${encodeURIComponent(msg())}`; window.open(url,"_blank"); saveSiteMessage(p,"wa",msg()); };
      $("#m-msg-mail").onclick=()=>{ const email=(p.contact_email||ADMIN_EMAIL||""); if(!email) return alert("Email non configur√©."); const url=`mailto:${email}?subject=${encodeURIComponent("Int√©r√™t pour: "+p.title)}&body=${encodeURIComponent(msg())}`; window.location.href=url; saveSiteMessage(p,"email",msg()); };
      $("#m-msg-site").onclick=()=>{ if(!CURRENT_USER) { alert("Connectez-vous pour envoyer un message priv√©."); document.getElementById("login-pop").classList.add("open"); window.scrollTo({top:0,behavior:"smooth"}); return; } saveSiteMessage(p,"site",msg(), true); alert("Message envoy√© (priv√©) ‚úÖ"); };

      // Jardin: bouton "Demander un devis"
      const btnDevis = document.getElementById("m-devis-wa");
      if (btnDevis){
        if (isJardin){
          btnDevis.style.display = "inline-block";
          btnDevis.onclick = ()=>{
            const phone = (p.contact_phone || ADMIN_PAYSAGISTE_PHONE || ADMIN_PHONE_E164 || "").replace(/[+ ]/g,"");
            if(!phone){ alert("Num√©ro WhatsApp non configur√©."); return; }
            const text = `Bonjour, je souhaite un devis pour mon jardin (cr√©ation/entretien).`;
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
            window.open(url, "_blank");
            saveSiteMessage(p,"wa_devis",text);
          };
        } else {
          btnDevis.style.display = "none";
          btnDevis.onclick = null;
        }
      }

      $("#m-share").onclick=async()=>{const text=`${p.title}\n${fmt(p.price)} FCFA ‚Ä¢ ${p.city} ${p.district}`; if(navigator.share){try{await navigator.share({title:p.title,text})}catch{}}else{try{await navigator.clipboard.writeText(text);alert("D√©tails copi√©s ‚úÖ")}catch{alert(text)}}};
      $("#m-close").onclick=()=>closeModal("#modal");
      $("#overlay").onclick=()=>closeModal("#modal");
      openModal("#modal");
    }

    function render(){
      STATE.listings = loadListings();
      const filtered=filteredListings()
       .sort((a,b)=>{if(STATE.sortBy==="price-asc")return a.price-b.price; if(STATE.sortBy==="price-desc")return b.price-a.price; if(STATE.sortBy==="area")return (b.area||0)-(a.area||0); if(STATE.sortBy==="recent")return new Date(b.created_at||"2000-01-01")-new Date(a.created_at||"2000-01-01"); return 0});
      const grid=$("#grid"), empty=$("#empty"); grid.innerHTML="";
      filtered.forEach(p=>{
        const card=document.createElement("div"); card.className="card";
        const coverBox=document.createElement("div"); coverBox.className="cover-box";
        const img=document.createElement("img"); img.className="cover"; img.alt=p.title; img.src=(p.photos&&p.photos[0])||""; img.loading="lazy"; coverBox.appendChild(img);
        const inner=document.createElement("div"); inner.className="inner";
        const top=document.createElement("div"); top.className="toolbar"; top.style.justifyContent="space-between";
        const title=document.createElement("div"); title.style.fontWeight="700"; title.textContent=`${icon(p.kind)} ${p.title}`;
        const badge=document.createElement("span"); badge.className="badge"; badge.textContent=p.type==="vente"?"√Ä vendre":"√Ä louer";
        top.appendChild(title); top.appendChild(badge);
        const isHotel=(String(p.kind||"").toLowerCase().includes("h√¥tel")||String(p.kind||"").toLowerCase().includes("hotel"));
        const isJardin=(String(p.kind||"").toLowerCase()==="jardin");
        const price=document.createElement("div"); price.style.fontWeight="800"; price.style.margin="6px 0";
        price.innerHTML = isJardin
          ? `<span class="muted">Service de paysagisme</span>`
          : `<span style="background:var(--greenBadgeBg);color:#111;padding:2px 6px;border:1px solid var(--greenPure);border-radius:6px">
               ${fmt(p.price)} FCFA${p.type==="location" ? ` / ${isHotel?"nuit":"mois"}` : ""}
             </span>`;
        const geo=document.createElement("div"); geo.className="muted"; geo.textContent=`${p.city} ‚Ä¢ ${p.district}`;
        const btns=document.createElement("div"); btns.className="toolbar"; btns.style.marginTop="8px";
        const voir=document.createElement("button"); voir.className="btn install"; voir.textContent="Voir"; voir.onclick=()=>openDetail(p.id);
        const fav=document.createElement("button"); fav.className="btn"; fav.textContent=STATE.favs.has(p.id)?"‚òÖ Favori":"‚òÜ Favori"; fav.onclick=()=>{if(STATE.favs.has(p.id))STATE.favs.delete(p.id);else STATE.favs.add(p.id);db_set(LS_FAVS,[...STATE.favs]);render();refreshCounters();};
        btns.appendChild(voir); btns.appendChild(fav);
        inner.appendChild(top); inner.appendChild(price); inner.appendChild(geo); inner.appendChild(btns);
        card.appendChild(coverBox); card.appendChild(inner); grid.appendChild(card);
      });
      empty.style.display=filtered.length?"none":"block";
      refreshCounters();
    }

    // publier
    $("#btn-publish").addEventListener("click",()=>{
      const citySel2=$("#p-city"), distSel2=$("#p-district"), distNew=$("#p-district-new");
      const addBtn=$("#p-add-district");
      function refreshCitySelect2(select,withEmpty=false){select.innerHTML=withEmpty?'<option value="">Ville</option>':"";Object.keys(CI_CITIES).forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;select.appendChild(o)})}
      function refreshDistrictSelect2(select,city,withEmpty=false){select.innerHTML=withEmpty?'<option value="">Quartier</option>':"";(CI_CITIES[city]||[]).forEach(d=>{const o=document.createElement("option");o.value=d;o.textContent=d;select.appendChild(o)})}
      refreshCitySelect2(citySel2,false);
      const firstCity=Object.keys(CI_CITIES)[0]; citySel2.value=firstCity||""; refreshDistrictSelect2(distSel2, citySel2.value,false);
      distNew.style.display="none"; addBtn.onclick=()=>{distNew.style.display="block"; distNew.focus()};
      citySel2.onchange=()=>refreshDistrictSelect2(distSel2, citySel2.value,false);
      openModal("#pub-modal");
    });
    $("#p-use-gps").addEventListener("click",()=>{
      if(!navigator.geolocation) return alert("GPS non disponible");
      navigator.geolocation.getCurrentPosition(pos=>{$("#p-lat").value=pos.coords.latitude.toFixed(6);$("#p-lng").value=pos.coords.longitude.toFixed(6);},()=>alert("Impossible d‚Äôobtenir la position"));
    });
    let CURRENT_USER=null;
    $("#pub-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const city=$("#p-city").value; let district=$("#p-district").value;
      const districtNew=$("#p-district-new").value.trim();
      if(districtNew){ district=districtNew; const custom=getCustomDistricts(); custom[city]=Array.from(new Set([...(custom[city]||[]), district])); saveCustomDistricts(custom); CI_CITIES=getCities(); try{await supabase.from("districts").upsert({city,district,lat:Number($("#p-lat").value)||null,lng:Number($("#p-lng").value)||null});}catch{} }
      const item={id:`P-${Date.now()}`,title:$("#p-title").value.trim(),type:$("#p-type").value,kind:$("#p-kind").value,price:Number($("#p-price").value)||0,city,district,bedrooms:Number($("#p-bed").value)||0,bathrooms:Number($("#p-bath").value)||0,area:Number($("#p-area").value)||0,lat:$("#p-lat").value?Number($("#p-lat").value):null,lng:$("#p-lng").value?Number($("#p-lng").value):null,photos:REAL[$("#p-kind").value]||REAL.villa,created_at:new Date().toISOString(),contact_phone:$("#p-whats").value.trim(),contact_email:$("#p-email").value.trim(),owner_id:CURRENT_USER?.id||null};
      if(!item.title) return alert("Titre requis");
      saveListing(item); render(); if($("#map").style.display!=="none") initMap(true);
      try{await supabase.from("listings").upsert(item);}catch{}
      alert("Annonce publi√©e ‚úÖ"); closeModal("#pub-modal");
    });

    // PDF export
    async function ensureLibs(){ while(!(window.jspdf && window.html2canvas)){ await new Promise(r=>setTimeout(r,50)); } }
    async function exportPdf(){
      await ensureLibs(); const { jsPDF } = window.jspdf; const el = document.getElementById("fiche");
      if (!el) return alert('Zone "fiche" introuvable.');
      const canvas = await html2canvas(el, { scale:2, backgroundColor:"#ffffff" });
      const imgData = canvas.toDataURL("image/png"); const pdf = new jsPDF("p","mm","a4");
      const W = pdf.internal.pageSize.getWidth(), H = pdf.internal.pageSize.getHeight();
      const m = 10, imgW = W - m*2, imgH = canvas.height * imgW / canvas.width; let left = imgH, pos = m;
      pdf.addImage(imgData,"PNG",m,pos,imgW,imgH); left -= (H - m*2);
      while(left>0){ pdf.addPage(); pos = m - (imgH - left); pdf.addImage(imgData,"PNG",m,pos,imgW,imgH); left -= (H - m*2); }
      pdf.save("ma_fiche.pdf");
    }
    $("#btnPdf").addEventListener("click", exportPdf);

    // AUTH + profils
    async function refreshUI(user){
      CURRENT_USER = user || null;
      const fiche=$("#fiche"), pdfbar=$("#pdf-bar"), alertLogin=$("#alert-login");
      const who=$("#nh-who"), after=$("#after-login");
      if (user){
        if(who) who.textContent = user.email || user.id;
        alertLogin.style.display="none"; fiche.style.display="block"; pdfbar.style.display="flex";
        $("#fiche-nom").textContent=(user.user_metadata?.name)||"-"; $("#fiche-email").textContent=user.email||"-";
        if(after) after.style.display="block";
        const pend=db_get(LS_PENDING_PROFILE,null);
        if(pend){ try{ await supabase.from("profiles").upsert({ id:user.id, ...pend, email:user.email }); db_set(LS_PENDING_PROFILE,null);}catch{} }
      } else {
        alertLogin.style.display="block"; fiche.style.display="none"; pdfbar.style.display="none";
        if(after) after.style.display="none"; $("#fiche-nom").textContent="-"; $("#fiche-email").textContent="-";
      }
    }
    $("#insc-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const profil = {nom:$("#f-nom").value.trim(), prenom:$("#f-prenom").value.trim(), date_naissance:$("#f-dnaiss").value, lieu_naissance:$("#f-lnaiss").value.trim(), adresse:$("#f-adresse").value.trim(), titre:$("#f-titre").value.trim(), statut:$("#f-statut").value};
      const email=$("#f-email").value.trim(), password=$("#f-pass").value;
      if(!email||!password||!profil.nom||!profil.prenom||!profil.date_naissance||!profil.lieu_naissance||!profil.statut) return alert("Merci de remplir tous les champs requis.");
      const { error } = await supabase.auth.signUp({ email, password, options:{ data:{ name: profil.prenom+" "+profil.nom, ...profil } } });
      if(error){ alert(error.message); return; }
      db_set(LS_PENDING_PROFILE, profil); alert("Compte cr√©√© ‚úÖ. V√©rifie ton email puis connecte-toi."); closeModal("#insc-modal"); $("#login-pop").classList.add("open");
    });
    supabase.auth.onAuthStateChange(async (_e, session)=>{ await refreshUI(session?.user || null); });
    const { data: { session } } = await supabase.auth.getSession(); await refreshUI(session?.user || null);

    // messages priv√©s
    function saveSiteMessage(listing, via, text, requireAuth=false){
      const msgs=db_get(LS_MSG,[]);
      const rec={id:`M-${Date.now()}`, listing_id:listing.id, owner_id:listing.owner_id||null, from_user_id:CURRENT_USER?.id||null, from_email:CURRENT_USER?.email||null, text, via, created_at:new Date().toISOString()};
      msgs.push(rec); db_set(LS_MSG,msgs);
      (async ()=>{ try{ await supabase.from("messages").insert(rec);}catch{} })();
      if(requireAuth && !CURRENT_USER) return false;
      return true;
    }

    // tableau de bord
    function loadDashboard(){
      const tabs=qsa("#dash-modal [data-tab]"); tabs.forEach(b=>b.onclick=()=>{qsa("#dash-modal .tab").forEach(t=>t.style.display="none"); $("#"+b.dataset.tab).style.display="block"});
      (async ()=>{
        try{
          const { data, error } = await supabase.from("profiles").select("id,nom,prenom,email,statut,created_at").order("created_at",{ascending:false}).limit(200);
          const box=$("#tab-profiles"); if(error){ box.textContent="‚Äî"; return; }
          const rows=(data||[]).map(p=>`<tr><td>${p.prenom||""} ${p.nom||""}</td><td>${p.email||""}</td><td>${p.statut||""}</td><td>${(p.created_at||"").slice(0,10)}</td></tr>`).join("");
          box.innerHTML=`<div style="overflow:auto"><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left">Nom</th><th style="text-align:left">Email</th><th style="text-align:left">Statut</th><th style="text-align:left">Cr√©√© le</th></tr></thead><tbody>${rows||"<tr><td colspan=4 class='muted'>Aucun profil</td></tr>"}</tbody></table></div>`;
        }catch{ $("#tab-profiles").textContent="Connectez Supabase pour voir les inscrits."; }
      })();
      const my=(loadListings().filter(x=>x.owner_id && CURRENT_USER && x.owner_id===CURRENT_USER.id));
      $("#tab-mylistings").innerHTML = my.length? my.map(x=>`<div class="card" style="padding:12px;margin-bottom:8px"><b>${x.title}</b><div class="muted">${x.city} ‚Ä¢ ${x.district}</div></div>`).join("") : "<div class='muted'>Aucune annonce (publiez-en une).</div>";
      const msgs=db_get(LS_MSG,[]).filter(m=>!CURRENT_USER || (m.owner_id===CURRENT_USER.id));
      $("#tab-messages").innerHTML = msgs.length? msgs.reverse().map(m=>`<div class="card" style="padding:12px;margin-bottom:8px"><div><b>${m.via.toUpperCase()}</b> ‚Äî ${new Date(m.created_at).toLocaleString()}</div><div class="muted">Annonce: ${m.listing_id}</div><div style="margin-top:6px">${m.text}</div></div>`).join("") : "<div class='muted'>Aucun message.</div>";
    }

    // === BOT FLOTTANT ‚Äî FAQ √©largie ===
    (function(){
      const botPanel=$("#bot-panel"), botButton=$("#bot-button"), botClose=$("#bot-close");
      const botBody=$("#bot-body"), botText=$("#bot-text"), botSend=$("#bot-send");

      function botSay(html){ const wrap=document.createElement("div"); wrap.className="bot-msg"; wrap.innerHTML=`<div class="bubble">${html}</div>`; botBody.appendChild(wrap); botBody.scrollTop=botBody.scrollHeight; }
      function meSay(text){ const wrap=document.createElement("div"); wrap.className="bot-msg me"; wrap.innerHTML=`<div class="bubble">${text}</div>`; botBody.appendChild(wrap); botBody.scrollTop=botBody.scrollHeight; }
      function chips(){
        const c=document.createElement("div"); c.className="chips";
        [["Trouver une maison","maison"],["Voir h√¥tels","h√¥tel"],["Voir terrains","terrain"],["Pr√®s de moi","pr√®s de moi"],["Cr√©er un compte","inscription"],["Ouvrir le GPS","gps"],["Paysagiste (Jardin)","jardin"]]
          .forEach(([label,val])=>{ const chip=document.createElement("div"); chip.className="chip"; chip.textContent=label; chip.onclick=()=>{ botText.value=val; botSend.click(); }; c.appendChild(chip); });
        botBody.appendChild(c);
      }

      function setKind(v){ const kSel=$("#kind-filter"); if(kSel){kSel.value=v||"";} STATE.kind=v||""; render(); }
      function openExplore(){ $("#btn-explore")?.click(); }
      function openSignup(){ $("#btn-abonnement")?.click(); }
      function openAccount(){ $("#btn-account")?.click(); }
      function openGPS(){ showMap(); }
      function nearMe(){ $("#btn-near-filter")?.click(); }

      function handle(text){
        const t=(text||"").toLowerCase().trim();
        if(!t){ botSay("Bonjour üëã Je peux vous aider √† <b>trouver une maison</b>, un <b>h√¥tel</b>, un <b>terrain</b>, √† <b>utiliser le GPS</b>, √† <b>voir les biens pr√®s de vous</b>, √† <b>cr√©er un compte</b>, ou √† contacter notre <b>paysagiste (Jardin)</b>."); chips(); return; }

        if(t.includes("h√¥tel")||t.includes("hotel")){ setKind("h√¥tel"); openExplore(); botSay("üè® J‚Äôaffiche les h√¥tels disponibles."); return; }
        if(t.includes("terrain")){ setKind("terrain"); openExplore(); botSay("üó∫Ô∏è J‚Äôaffiche les terrains disponibles."); return; }
        if(t.includes("maison")||t.includes("appartement")||t.includes("villa")||t.includes("studio")){ setKind(""); openExplore(); botSay("üè† Utilisez les filtres (type, ville, budget)."); return; }

        if(t.includes("paysagiste")||t.includes("jardin")||t.includes("fleurs d‚Äôeden")||t.includes("fleurs d'eden")){
          setKind("jardin"); openExplore();
          botSay("üåø <b>Les Fleurs d‚ÄôEden</b><br>üìû +2250700435569<br>‚úâÔ∏è claudbrou01@gmail.com<br>J‚Äôouvre la section Jardin.");
          return;
        }

        if(t.includes("pr√®s de moi")||t.includes("proche")||t.includes("autour de moi")){ nearMe(); botSay("üìç J‚Äôaffiche les biens dans un rayon de 10 km autour de vous."); return; }
        if(t.includes("gps")||t.includes("carte")||t.includes("localisation")){ openGPS(); botSay("üó∫Ô∏è Carte ouverte. Utilisez ¬´ Pr√®s de moi ¬ª pour les biens proches."); return; }

        if(t.includes("cr√©er un compte")||t.includes("inscription")||t.includes("s‚Äôinscrire")||t.includes("sinscrire")){ openSignup(); botSay("üìù Remplissez le formulaire puis validez votre email."); return; }
        if(t.includes("se connecter")||t.includes("connexion")||t.includes("compte")){ openAccount(); botSay("üîê Ouvrez ¬´ Compte ¬ª pour vous connecter."); return; }

        if(t.includes("publier")||t.includes("annonce")){ document.getElementById("btn-publish")?.click(); botSay("üßæ Publiez une annonce depuis ce formulaire."); return; }

        botSay("Je peux : <b>maisons</b>, <b>h√¥tels</b>, <b>terrains</b>, <b>Jardin</b>, <b>GPS</b>, <b>pr√®s de moi</b>, <b>cr√©er un compte</b>. Essayez ¬´ h√¥tels ¬ª, ¬´ terrain ¬ª, ¬´ pr√®s de moi ¬ª.");
        chips();
      }

      botButton?.addEventListener("click",()=>{ botPanel.classList.toggle("open"); if(botPanel.classList.contains("open")){ botBody.innerHTML=""; botSay("Bonjour üëã, en quoi puis-je vous aider ?"); chips(); } });
      botClose?.addEventListener("click",()=>botPanel.classList.remove("open"));
      botSend?.addEventListener("click",()=>{ const v=botText.value; if(v){meSay(v);} botText.value=""; handle(v); });
      botText?.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); botSend.click(); } });
    })();

    // Gestion universelle des boutons [data-close] + √âchap
    qsa("[data-close]").forEach(b=>{
      b.addEventListener("click",()=>{ const sel=b.getAttribute("data-close"); if(sel) closeModal(sel); });
    });
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){ ["#modal","#insc-modal","#pub-modal","#dash-modal"].forEach(sel=>closeModal(sel)); }
    });

    // d√©marrage
    render(); // carte masqu√©e par d√©faut
  </script>
</body>
</html>


