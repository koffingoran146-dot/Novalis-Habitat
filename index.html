 <script type="module"> to add constants, REAL.jardin, TYPES inclusion, icon handling,
#    sample listing for the paysagiste, and bot logic and map marker colors.
script = soup.find("script", {"type": "module"})
code = script.string

# Insert additional admin constants after ADMIN_EMAIL
code = code.replace(
    'const ADMIN_EMAIL      = "contact@novalisabita.ci";',
    'const ADMIN_EMAIL      = "contact@novalisabita.ci";\n'
    '    const ADMIN_PAYSAGISTE_NAME  = "M. Brou Claude";\n'
    '    const ADMIN_PAYSAGISTE_PHONE = "+225XXXXXXXXXX"; // ‚á¶ Remplacez par le vrai num√©ro du paysagiste'
)

# Add REAL.jardin image source and include in REAL object if missing
code = re.sub(
    r'(const REAL=\{[^}]+\});',
    lambda m: m.group(1).replace('};', ',jardin:["https://source.unsplash.com/1024x640/?garden,landscape,plants,africa&sig=61"]};'),
    code,
    count=1
)

# Add sample listing for paysagiste in SAMPLE if not already present
if "P-JARDIN" not in code:
    sample_insert = (
        '{id:"P-JARDIN",title:"Paysagiste ‚Äî Jardin √† domicile",type:"location",kind:"jardin",'
        'price:0,city:"Abidjan",district:"Cocody",bedrooms:0,bathrooms:0,area:0,lat:5.348,lng:-3.985,'
        'photos:REAL.jardin,created_at:"2025-07-15T09:30:00Z",contact_phone:ADMIN_PAYSAGISTE_PHONE,contact_email:ADMIN_EMAIL}'
    )
    code = code.replace(
        'const SAMPLE=[',
        f'const SAMPLE=[{sample_insert},'
    )

# Ensure TYPES includes "jardin"
code = code.replace(
    'const TYPES=["appartement","villa","studio","terrain","bureau","maison","duplex","immeuble","h√¥tel","hotel"];',
    'const TYPES=["appartement","villa","studio","terrain","bureau","maison","duplex","immeuble","h√¥tel","hotel","jardin"];'
)

# Update icon() to support jardin
code = code.replace(
    'function icon(kind){const k=(kind||"").toLowerCase(); if(k==="h√¥tel"||k==="hotel") return "üè®"; if(k==="terrain") return "üåç"; if(k==="villa") return "üè°"; if(k==="studio") return "üõèÔ∏è"; if(k==="appartement") return "üè¢"; return "üè†";}',
    'function icon(kind){const k=(kind||"").toLowerCase(); if(k==="h√¥tel"||k==="hotel") return "üè®"; if(k==="terrain") return "üåç"; if(k==="villa") return "üè°"; if(k==="studio") return "üõèÔ∏è"; if(k==="appartement") return "üè¢"; if(k==="jardin") return "üåø"; return "üè†";}'
)

# 3) Adjust markerIcon: orange point; price badge light green background, black text.
#    For jardin kind, show label "Paysagiste" instead of price number.
marker_pattern = r'function markerIcon\(kind, price\)\{[\s\S]*?\}'
new_marker = '''
    function markerIcon(kind, price){
      const emoji = icon(kind);
      const isJardin = String(kind||"").toLowerCase()==="jardin";
      const amount = isJardin ? 'Paysagiste' : (fmt(price) + ' Franc CFA');
      return L.divIcon({
        className:"",
        html: `
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="width:12px;height:12px;border-radius:999px;background:var(--orange);box-shadow:0 0 0 2px #fff,0 2px 8px rgba(0,0,0,.25)"></span>
            <span style="font-weight:800;color:#111;background:#d1fae5;border:1px solid var(--green);border-radius:10px;padding:3px 8px">${amount}</span>
            <span>${emoji}</span>
          </div>`,
        iconSize:[10,10],
        iconAnchor:[20,20]
      });
    }
'''
code = re.sub(marker_pattern, new_marker, code)

# 4) When creating markers, ensure click opens details (already does). We'll also focus the message box after opening.
code = code.replace(
    '.on(\'click\',()=>openDetail(p.id))',
    ".on('click',()=>{ openDetail(p.id); setTimeout(()=>{ const t=document.getElementById('m-msg'); if(t){ t.focus(); t.select(); } }, 50); })"
)

# 5) In render(), tweak price display for jardin (replace numeric price with "Service paysagiste").
code = code.replace(
    'const isHotel=(String(p.kind||"").toLowerCase().includes("h√¥tel")||String(p.kind||"").toLowerCase().includes("hotel"));',
    'const isHotel=(String(p.kind||"").toLowerCase().includes("h√¥tel")||String(p.kind||"").toLowerCase().includes("hotel"));\n        const isJardin=(String(p.kind||"").toLowerCase()==="jardin");'
)
code = code.replace(
    'price.innerHTML = p.type==="vente" ? `${fmt(p.price)} <span class="muted">FCFA</span>` : `${fmt(p.price)} <span class="muted">FCFA / ${isHotel?"nuit":"mois"}</span>`;',
    'price.innerHTML = isJardin ? `<span class="muted">Service de paysagisme</span>` : (p.type==="vente" ? `${fmt(p.price)} <span class="muted">FCFA</span>` : `${fmt(p.price)} <span class="muted">FCFA / ${isHotel?"nuit":"mois"}</span>`);'
)

# 6) In modal detail, tweak for jardin: show a tailored description and CTA.
code = code.replace(
    'const isHotel=(String(p.kind||"").toLowerCase().includes("h√¥tel")||String(p.kind||"").toLowerCase().includes("hotel"));',
    'const isHotel=(String(p.kind||"").toLowerCase().includes("h√¥tel")||String(p.kind||"").toLowerCase().includes("hotel"));\n      const isJardin=(String(p.kind||"").toLowerCase()==="jardin");'
)
code = code.replace(
    '$("#m-price").textContent = p.type==="vente" ? `${fmt(p.price)} FCFA` : `${fmt(p.price)} FCFA / ${isHotel?"nuit":"mois"}`;',
    '$("#m-price").textContent = isJardin ? "Service de paysagisme" : (p.type==="vente" ? `${fmt(p.price)} FCFA` : `${fmt(p.price)} FCFA / ${isHotel?"nuit":"mois"}`);'
)
code = code.replace(
    '$("#m-desc").textContent = "Contactez-nous pour plus d‚Äôinformations.";',
    '$("#m-desc").textContent = isJardin ? "Cr√©ation et entretien de jardins √† domicile. Contactez le paysagiste pour un devis." : "Contactez-nous pour plus d‚Äôinformations.";'
)

# 7) Add simple bot logic:
#    - If user mentions "jardin" or "paysagiste", suggest the Jardin listing and show contact (WhatsApp link).
#    - If user mentions "maison", "villa", etc., suggest using filters and open Explore.
#    Implement click handlers and add a few quick chips.
bot_inject_js = r"""
    // === Assistant bot basic logic ===
    const botBody = $("#bot-body");
    const botText = $("#bot-text");
    const botSend = $("#bot-send");
    const botButton = $("#bot-button");
    const botPanel = $("#bot-panel");
    const WA_PAYSAGISTE = ADMIN_PAYSAGISTE_PHONE ? ("https://wa.me/" + ADMIN_PAYSAGISTE_PHONE.replace(/[+ ]/g,"")) : waLink;

    function botSay(html){ const wrap=document.createElement("div"); wrap.className="bot-msg"; wrap.innerHTML=`<div class="bubble">${html}</div>`; botBody.appendChild(wrap); botBody.scrollTop=botBody.scrollHeight; }
    function meSay(text){ const wrap=document.createElement("div"); wrap.className="bot-msg me"; wrap.innerHTML=`<div class="bubble">${text}</div>`; botBody.appendChild(wrap); botBody.scrollTop=botBody.scrollHeight; }

    function suggestChips(){
      const chips=document.createElement("div"); chips.className="chips";
      const opts=[
        ["Trouver une maison","maison"],
        ["Voir Jardin / Paysagiste","paysagiste"],
        ["Voir les annonces r√©centes","explorer"]
      ];
      opts.forEach(([label, val])=>{
        const c=document.createElement("div"); c.className="chip"; c.textContent=label;
        c.onclick=()=>{ botText.value=val; botSend.click(); };
        chips.appendChild(c);
      });
      botBody.appendChild(chips);
    }

    function handleBot(text){
      const t=(text||"").toLowerCase();
      if(!t.trim()){ botSay("Dis-moi ce que tu cherches : une maison, un appartement‚Ä¶ ou un <b>paysagiste</b> pour ton jardin üåø."); suggestChips(); return; }
      if(t.includes("paysagiste") || t.includes("jardin")){
        botSay(`<div><b>Paysagiste recommand√© :</b><br>${ADMIN_PAYSAGISTE_NAME}<br>` +
               (ADMIN_PAYSAGISTE_PHONE?`üìû ${ADMIN_PAYSAGISTE_PHONE}<br>`:"") +
               (WA_PAYSAGISTE?`<a target="_blank" href="${WA_PAYSAGISTE}">Contacter sur WhatsApp</a><br>`:"") +
               `</div><div style="margin-top:6px">Je t‚Äôouvre la section <b>Jardin</b> dans les annonces.</div>`);
        // Filter by kind=jardin and scroll
        kindSel.value="jardin"; STATE.kind="jardin"; render(); document.getElementById("grid").scrollIntoView({behavior:"smooth"});
        return;
      }
      if(t.includes("maison") || t.includes("villa") || t.includes("appartement") || t.includes("studio")){
        botSay("Okay, utilise les filtres en haut (type de bien, ville, budget). Je t‚Äôouvre la section Explorer.");
        document.getElementById("btn-explore").click();
        return;
      }
      if(t.includes("explorer")){
        document.getElementById("btn-explore").click();
        botSay("Voil√† les annonces r√©centes ‚ú®");
        return;
      }
      botSay("Je peux t‚Äôaider √† trouver un bien ou un paysagiste. Essaie : ¬´ paysagiste ¬ª ou ¬´ maison √† Cocody ¬ª.");
      suggestChips();
    }

    botSend.addEventListener("click",()=>{ const v=botText.value; if(!v) return handleBot(v); meSay(v); botText.value=""; handleBot(v); });
    botText.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); botSend.click(); }});
    botButton.addEventListener("click",()=>{ botPanel.classList.toggle("open"); if(botPanel.classList.contains("open")){ botBody.innerHTML=""; botSay("Hello üëã Je suis l√† pour t‚Äôorienter."); suggestChips(); }});
"""
# insert bot logic right before the final comment " // d√©marrage"
code = code.replace(
    "// d√©marrage",
    bot_inject_js + "\n    // d√©marrage"
)

# 8) Ensure filteredListings includes jardin via kind filter (already handled by kindSel). No change needed.

# 9) Save modified code back into the script tag
script.string.replace_with(code)

# Write output
pathlib.Path(out_path).write_text(str(soup), encoding="utf-8")

out_path
