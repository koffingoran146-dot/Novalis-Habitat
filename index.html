<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovalisHabitat.CI</title>
  <meta name="theme-color" content="#ff7f00" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <style>
    :root{
      --orange:#ff7f00; --green:#10b981; --txt:#0f172a; --muted:#6b7280; --bd:#e5e7eb; --bg:#FFF4E6; --white:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    a{color:#0ea5e9;text-decoration:none}

    .container{max-width:1200px;margin:0 auto;padding:12px 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:900;display:flex;align-items:center;gap:6px;cursor:pointer}
    .brand i{width:12px;height:12px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-size:10px;line-height:1.1}
    .brand .o{background:#ff7f00;color:#fff}
    .brand .w{background:#e5e7eb}
    .brand .g{background:#10b981;color:#fff}
    .metrics{display:flex;gap:6px;margin-left:8px}
    .metric{display:inline-flex;align-items:center;gap:6px;font-weight:700}

    .header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--bd)}
    .spacer{flex:1}
    .btn{border:1px solid var(--bd);border-radius:12px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:600}
    .btn:hover{transform:translateY(-1px)}
    .btn.install{background:var(--orange);border-color:var(--orange);color:#fff}

    .pill{border:1px solid var(--bd);border-radius:999px;padding:6px 12px;background:#fff;cursor:pointer}
    .pill.active{background:var(--green);color:#fff;border-color:transparent}
    input,select,textarea{border:1px solid var(--bd);border-radius:12px;padding:8px 12px;background:#fff;font-size:14px}
    textarea{min-height:96px;resize:vertical}
    .muted{color:var(--muted)}

    /* fiche */
    #fiche{max-width:1100px;margin:10px auto 0;padding:12px;border:1px solid #111a38;border-radius:14px;background:#0f1530;color:#e9eefb}
    #pdf-bar{max-width:1100px;margin:8px auto 0;display:flex;gap:8px}
    #alert-login{position:fixed;left:16px;top:12px;background:#0f1530;color:#e9eefb;border:1px solid #111a38;border-radius:12px;padding:6px 10px;z-index:40;display:none}

    /* map */
    #map{max-width:1200px;margin:16px auto;border:1px solid var(--bd);border-radius:12px;background:#fff;padding:10px}
    #leaf{height:520px;border-radius:12px;overflow:hidden}

    /* grid */
    .grid{max-width:1200px;margin:0 auto 80px;display:grid;gap:16px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{border:1px solid var(--bd);border-radius:16px;overflow:hidden;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .cover-box{width:100%;aspect-ratio:16/9;background:#e5e7eb;position:relative;overflow:hidden}
    .cover{width:100%;height:100%;object-fit:cover;display:block}
    .inner{padding:12px}
    .badge{display:inline-flex;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;font-size:12px;gap:6px}

    /* modal + sheet */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .dialog{position:relative;z-index:1;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);max-width:980px;width:100%;max-height:90vh;display:flex;flex-direction:column}
    .dialog .head{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:12px}
    .dialog .body{padding:12px;overflow:auto}

    .sheet{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:10px}
    .sheet.open{display:flex}
    .sheet .panel{position:relative;z-index:1;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);max-width:760px;width:100%;max-height:92vh;display:flex;flex-direction:column}
    .sheet .head{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:12px;font-weight:800}
    .sheet .body{padding:12px;overflow:auto}

    /* footer */
    footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--bd)}
    .foot{max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px}
    .foot-center{margin-left:auto;color:#334155;font-weight:600}

    /* chatbot */
    #bot-btn{position:fixed;right:16px;bottom:80px;width:56px;height:56px;border-radius:50%;background:#111a38;color:#e9eefb;border:2px solid #111a38;display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.22);z-index:50}
    #bot{position:fixed;right:16px;bottom:150px;width:320px;max-height:60vh;background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none;flex-direction:column;overflow:hidden;z-index:50}
    #bot.open{display:flex}
    #bot .bot-head{background:#0f1530;color:#e9eefb;padding:10px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    #bot .bot-body{padding:10px;overflow:auto;flex:1}
    #bot .bot-msg{margin:8px 0;padding:8px 10px;border-radius:12px;max-width:92%}
    #bot .bot-a{background:#e2e8f0;align-self:flex-start}
    #bot .bot-u{background:#d1fae5;align-self:flex-end}
    #bot .quick{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    #bot .quick button{border:1px solid var(--bd);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}

    .row{display:grid;gap:10px}
    @media(min-width:600px){.row{grid-template-columns:repeat(2, 1fr)}}
    .help{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <div id="alert-login">Connectez-vous pour déverrouiller toutes les fonctions.</div>

  <!-- Bouton PDF + Fiche compactes -->
  <div id="pdf-bar" class="container">
    <button id="btnPdf" class="btn">Télécharger ma fiche (PDF)</button>
  </div>
  <section id="fiche">
    <h2>Ma fiche</h2>
    <p>Nom : <span id="fiche-nom">-</span></p>
    <p>Email : <span id="fiche-email">-</span></p>
  </section>

  <!-- Header -->
  <div class="header">
    <div class="container toolbar">
      <div id="brand" class="brand" title="Accueil">
        <span style="color:#ff7f00">Novalis</span><span style="color:#0f172a">Habitat</span><span style="color:#10b981">.CI</span>
        <span class="metrics">
          <span class="metric" title="Annonces visibles"><i class="o"></i><span id="m-ads">0</span></span>
          <span class="metric" title="Visites du site"><i class="w"></i><span id="m-views">0</span></span>
          <span class="metric" title="Favoris"><i class="g"></i><span id="m-favs">0</span></span>
        </span>
      </div>
      <div class="spacer"></div>

      <button id="btn-explore" class="btn">Explorer</button>
      <button id="btn-gps" class="btn">Localisation</button>
      <button id="btn-abonnement" class="btn">Inscription</button>
      <button id="btn-install" class="btn install">Installer l’application</button>
      <button id="btn-dash" class="btn">Tableau de bord</button>
      <button id="btn-config" class="btn" title="Configurer Supabase et contacts">⚙️ Config</button>
    </div>

    <!-- Auth bar compacte -->
    <div class="container toolbar" style="padding-top:0">
      <div id="nh-login" class="toolbar" style="gap:8px">
        <input id="nh-email" type="email" placeholder="Email" />
        <input id="nh-password" type="password" placeholder="Mot de passe" />
        <button class="btn" id="btn-in">Se connecter</button>
        <button class="btn" id="btn-up">Créer un compte</button>
      </div>
      <div id="nh-logout" class="toolbar" style="gap:8px;display:none">
        <span>Connecté : <b id="nh-who"></b></span>
        <button class="btn" id="btn-out">Se déconnecter</button>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="container toolbar" style="margin-top:12px">
    <button class="pill active" data-mode="all">Tout</button>
    <button class="pill" data-mode="vente">À vendre</button>
    <button class="pill" data-mode="location">À louer</button>

    <select id="city-filter"><option value="">Ville</option></select>
    <select id="district-filter" disabled><option value="">Quartier</option></select>

    <input type="number" id="max-price" placeholder="Budget max (FCFA)" min="0" />
    <button id="apply-filters" class="btn">Filtrer</button>
    <button id="btn-near-filter" class="btn">Près de moi</button>
    <select id="bedrooms">
      <option value="">Chambres (min)</option><option value="0">Studio</option><option value="1">1+</option><option value="2">2+</option><option value="3">3+</option><option value="4">4+</option>
    </select>

    <div style="width:100%"></div>
    <div id="type-pills" class="toolbar" style="gap:6px"></div>

    <span class="spacer"></span>
    <input id="search" placeholder="Rechercher…" style="min-width:220px" />
    <button id="btn-search" class="btn">Rechercher</button>
    <select id="sort-by"><option value="recent">Tri: Récent</option><option value="price-asc">Tri: Prix ↑</option><option value="price-desc">Tri: Prix ↓</option><option value="area">Tri: Surface</option></select>
    <button id="btn-publish" class="btn">Créer une annonce</button>
  </div>

  <!-- Map -->
  <section id="map" class="container">
    <div style="font-weight:700;margin-bottom:6px">Carte & GPS — Côte d’Ivoire</div>
    <div class="toolbar" style="gap:8px;margin:8px 0">
      <button id="btn-ci" class="btn">Vue Côte d’Ivoire</button>
      <button id="btn-near" class="btn">Autour de moi</button>
    </div>
    <div id="leaf"></div>
  </section>

  <!-- Grid -->
  <main class="container">
    <div id="grid" class="grid" style="padding-bottom:60px"></div>
    <div id="empty" class="muted" style="text-align:center;padding:48px 0;display:none">Aucun résultat. <button class="btn" id="reset-filters">Réinitialiser</button> ✨</div>
  </main>

  <!-- Detail modal -->
  <div id="modal" class="modal">
    <div class="overlay" id="overlay"></div>
    <div class="dialog">
      <div class="head toolbar" style="justify-content:space-between">
        <div style="font-weight:700" id="m-title"></div>
        <div class="toolbar">
          <button class="btn" id="m-interest">Je suis intéressé</button>
          <button class="btn" id="m-fav">☆ Favori</button>
          <button class="btn" id="m-close">Fermer</button>
        </div>
      </div>
      <div class="body">
        <div id="m-geo" class="muted"></div>
        <div id="m-specs" class="muted"></div>
        <div style="font-size:18px;font-weight:700" id="m-price"></div>
        <p id="m-desc" class="muted"></p>
      </div>
    </div>
  </div>

  <!-- Sheet: Inscription -->
  <div id="sheet-sign" class="sheet" aria-hidden="true">
    <div class="overlay" data-close="#sheet-sign"></div>
    <div class="panel">
      <div class="head toolbar">
        <span>Inscription</span>
        <span class="spacer"></span>
        <button class="btn" data-close="#sheet-sign">Fermer</button>
      </div>
      <div class="body">
        <form id="form-sign" class="row" autocomplete="on">
          <input name="nom" placeholder="Nom" required />
          <input name="prenoms" placeholder="Prénoms" required />
          <input name="date_naissance" type="date" placeholder="Date de naissance" />
          <input name="lieu_naissance" placeholder="Lieu de naissance" />
          <input name="adresse" placeholder="Adresse" />
          <input name="email" type="email" placeholder="Email" required />
          <select name="fonction" required>
            <option value="">Fonction</option>
            <option>Étudiant</option><option>Particulier</option><option>Client</option>
          </select>
          <input name="whatsapp" placeholder="WhatsApp (+2250500803567…)" />
          <input name="telegram" placeholder="Telegram (@votrepseudo)" />
          <textarea name="bio" placeholder="À propos (facultatif)"></textarea>
          <div class="help">L’inscription est gratuite. Vous pourrez compléter votre profil plus tard.</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn install" type="submit">Valider l'inscription</button>
            <button class="btn" type="button" data-close="#sheet-sign">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sheet: Créer une annonce -->
  <div id="sheet-pub" class="sheet" aria-hidden="true">
    <div class="overlay" data-close="#sheet-pub"></div>
    <div class="panel">
      <div class="head toolbar">
        <span>Créer une annonce</span>
        <span class="spacer"></span>
        <button class="btn" data-close="#sheet-pub">Fermer</button>
      </div>
      <div class="body">
        <form id="form-pub" class="row">
          <input name="title" placeholder="Titre" required />
          <select name="type" required>
            <option value="location">À louer</option>
            <option value="vente">À vendre</option>
          </select>
          <select name="kind" required>
            <option>villa</option><option>appartement</option><option>studio</option><option>terrain</option><option>bureau</option><option>hôtel</option>
          </select>
          <input name="price" type="number" placeholder="Prix (FCFA)" min="0" required />
          <input name="city" placeholder="Ville (ex: Abidjan)" list="cities"/>
          <datalist id="cities"></datalist>
          <input name="district" placeholder="Quartier (ex: Cocody)" list="districts"/>
          <datalist id="districts"></datalist>
          <input name="bedrooms" type="number" min="0" placeholder="Chambres" />
          <input name="bathrooms" type="number" min="0" placeholder="Salles d’eau" />
          <input name="area" type="number" min="0" placeholder="Surface (m²)" />
          <input name="lat" type="number" step="any" placeholder="Latitude (optionnel)" />
          <input name="lng" type="number" step="any" placeholder="Longitude (optionnel)" />
          <input name="photo" type="url" placeholder="URL image (optionnel)" />
          <input name="owner_whatsapp" placeholder="WhatsApp du propriétaire" />
          <input name="owner_email" type="email" placeholder="Email du propriétaire" />
          <textarea name="desc" placeholder="Description (optionnel)"></textarea>
          <div class="help">Si le quartier n’existe pas, il sera ajouté automatiquement.</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn install" type="submit">Publier</button>
            <button class="btn" type="button" data-close="#sheet-pub">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sheet: Tableau de bord -->
  <div id="sheet-dash" class="sheet" aria-hidden="true">
    <div class="overlay" data-close="#sheet-dash"></div>
    <div class="panel">
      <div class="head toolbar">
        <span>Tableau de bord</span>
        <span class="spacer"></span>
        <button class="btn" data-close="#sheet-dash">Fermer</button>
      </div>
      <div class="body">
        <h3>Inscrits</h3>
        <div id="dash-users" class="muted">Chargement…</div>
        <h3 style="margin-top:16px">Annonces</h3>
        <div id="dash-ads" class="muted">Chargement…</div>
      </div>
    </div>
  </div>

  <!-- Sheet: Config (coller tes 2 clés ici) -->
  <div id="sheet-cfg" class="sheet" aria-hidden="true">
    <div class="overlay" data-close="#sheet-cfg"></div>
    <div class="panel">
      <div class="head toolbar">
        <span>Configuration</span>
        <span class="spacer"></span>
        <button class="btn" data-close="#sheet-cfg">Fermer</button>
      </div>
      <div class="body">
        <div class="help">Colle ici tes 2 valeurs Supabase. Elles seront enregistrées localement (navigateur).</div>
        <div class="row">
          <input id="cfg-url" placeholder="SUPABASE_URL (https://xxx.supabase.co)" />
          <input id="cfg-anon" placeholder="SUPABASE_ANON (eyJ...)" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn install" id="cfg-save">Enregistrer</button>
          <button class="btn" id="cfg-clear">Effacer</button>
        </div>
        <h4 style="margin-top:16px">Contacts du site</h4>
        <div class="row">
          <input id="cfg-phone" placeholder="WhatsApp du site" />
          <input id="cfg-mail" placeholder="Email du site" />
          <input id="cfg-telegram" placeholder="Telegram (ex: @NovalisHabitatCI)" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="cfg-contacts-save">Enregistrer les contacts</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chatbot -->
  <div id="bot-btn" title="Assistance">🤖</div>
  <div id="bot">
    <div class="bot-head">Assistance NovalisHabitat <button id="bot-x" class="btn" style="padding:4px 8px">×</button></div>
    <div class="bot-body" id="bot-body"></div>
    <div style="padding:8px;border-top:1px solid var(--bd);display:flex;gap:6px">
      <input id="bot-input" placeholder="Écrivez ici…" style="flex:1" />
      <button id="bot-send" class="btn">Envoyer</button>
    </div>
  </div>

  <footer>
    <div class="foot">
      <a href="#" id="f-explore" class="link">Explorer</a> |
      <a href="#" id="f-gps" class="link">Localisation</a> |
      <a href="#" id="f-contact" class="link">Contact</a>
      <div class="foot-center">© 2025 NovalisHabitat.CI — Abidjan, Côte d’Ivoire</div>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ========= CONFIG =========
    // 1) Contacts par défaut (déjà mis comme tu as demandé)
    const CONTACTS_DEFAULT = {
      whatsapp: "+2250500803567",
      email: "contact@novalishabitat.ci",
      telegram: "@NovalisHabitatCI"
    };

    // 2) Supabase — si tu ne veux JAMAIS toucher au code,
    //    ouvre ⚙️ Config dans le site et colle tes 2 valeurs.
    //    Le site les lira automatiquement depuis localStorage.
    const LS_CFG = "nh:cfg";
    const LS_CONTACTS = "nh:contacts";
    const cfg = JSON.parse(localStorage.getItem(LS_CFG) || "{}");
    const siteContacts = Object.assign({}, CONTACTS_DEFAULT, JSON.parse(localStorage.getItem(LS_CONTACTS) || "{}"));

    const SUPABASE_URL  = cfg.url  || ""; // ← sera rempli via ⚙️ Config
    const SUPABASE_ANON = cfg.anon || ""; // ← sera rempli via ⚙️ Config

    const supabase = (SUPABASE_URL && SUPABASE_ANON) ? createClient(SUPABASE_URL, SUPABASE_ANON) : null;

    // ========= HELPERS =========
    const $ = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
    const fmt = n => (n||0).toLocaleString("fr-FR");
    const toRad = x => x*Math.PI/180;
    const sleep = ms => new Promise(r=>setTimeout(r,ms));

    const CI_CITIES = {
      "Abidjan":["Plateau","Cocody","Yopougon","Abobo","Marcory","Treichville","Koumassi","Port-Bouët","Adjamé","Attécoubé","Bingerville","Anyama"],
      "Bouaké":["Koko","Air France","Dar-Es-Salam","Belleville"],
      "Yamoussoukro":["Morofé","Assabou","Millionnaire"],
      "San-Pédro":["Bardot","Balmer","Sogbô"],
      "Korhogo":["Haoussabougou","Sinistré"],
      "Daloa":["Kennedy","Abattoir"],
      "Man":["Grand-Gbapleu","Libreville"],
      "Gagnoa":["Garahio","Dioulabougou"],
      "Divo":["Plateau","8e Tranche"],
      "Abengourou":["Koumassi","Sogefia"],
      "Bondoukou":["Sokoro","Zanzan"],
      "Odienné":["Sogban","Kakologo"]
    };
    const TYPES = ["appartement","villa","studio","terrain","bureau","maison","duplex","immeuble","hôtel"];
    function icon(kind){const k=(kind||"").toLowerCase(); if(k==="hôtel"||k==="hotel") return "🏨"; if(k==="terrain") return "🌍"; if(k==="villa") return "🏡"; if(k==="studio") return "🛏️"; if(k==="appartement") return "🏢"; return "🏠";}
    function haversine(lat1,lon1,lat2,lon2){const R=6371, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(a));}

    // ========= LOCAL STORE KEYS =========
    const LS_LISTINGS="nh:listings", LS_FAVS="nh:favs", LS_ADMIN="nh:admin", LS_USERS="nh:users", LS_VIEWS="nh:views", LS_DISTRICTS="nh:districts";

    // ========= SAMPLE LISTINGS =========
    const REAL = {
      villa: ["https://source.unsplash.com/1024x640/?villa,house,modern,africa&sig=11"],
      appartement: ["https://source.unsplash.com/1024x640/?apartment,interior&sig=21"],
      hotel: ["https://source.unsplash.com/1024x640/?hotel,lagoon,water&sig=31"],
      studio: ["https://source.unsplash.com/1024x640/?studio,apartment,small&sig=41"],
      terrain: ["https://source.unsplash.com/1024x640/?land,plot,field,africa&sig=51"]
    };
    const SAMPLE=[
      {id:"P-002",title:"Villa moderne avec piscine — Cocody",type:"vente",kind:"villa",price:29000000,city:"Abidjan",district:"Cocody",bedrooms:4,bathrooms:3,area:220,lat:5.356,lng:-3.990,photos:REAL.villa,created_at:"2025-06-30T10:00:00Z"},
      {id:"P-001",title:"Appartement 3 pièces — Bouaké",type:"location",kind:"appartement",price:35000,city:"Bouaké",district:"Belleville",bedrooms:2,bathrooms:1,area:68,lat:7.690,lng:-5.030,photos:REAL.appartement,created_at:"2025-07-02T09:00:00Z"},
      {id:"P-004",title:"Hôtel bord lagune — Yamoussoukro",type:"location",kind:"hôtel",price:45000,city:"Yamoussoukro",district:"Morofé",bedrooms:20,bathrooms:20,area:1200,lat:6.820,lng:-5.270,photos:REAL.hotel,created_at:"2025-07-05T15:00:00Z"},
      {id:"P-003",title:"Studio simple — Daloa",type:"location",kind:"studio",price:20000,city:"Daloa",district:"Kennedy",bedrooms:1,bathrooms:1,area:24,lat:6.880,lng:-6.450,photos:REAL.studio,created_at:"2025-07-08T12:00:00Z"},
      {id:"P-005",title:"Terrain à vendre — San-Pédro",type:"vente",kind:"terrain",price:12000000,city:"San-Pédro",district:"Balmer",bedrooms:0,bathrooms:0,area:300,lat:4.748,lng:-6.636,photos:REAL.terrain,created_at:"2025-07-10T11:00:00Z"}
    ];

    // ========= STATE =========
    let STATE={listings:loadListings(),favs:new Set(db_get(LS_FAVS,[])),mode:"all",city:"",district:"",maxPrice:"",bedrooms:"",query:"",sortBy:"recent",selectedTypes:new Set(),openId:null};

    // ========= INIT SELECTS =========
    const citySel=$("#city-filter"), distSel=$("#district-filter");
    Object.keys(CI_CITIES).forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;citySel.appendChild(o)});
    citySel.addEventListener("change",()=>{STATE.city=citySel.value;STATE.district="";distSel.innerHTML='<option value="">Quartier</option>';distSel.disabled=!STATE.city;(getDistricts(STATE.city)).forEach(d=>{const o=document.createElement("option");o.value=d;o.textContent=d;distSel.appendChild(o)})});
    distSel.addEventListener("change",()=>{STATE.district=distSel.value});

    // ========= TYPE PILLS =========
    const typeCont=$("#type-pills");
    TYPES.forEach(t=>{const b=document.createElement("button");b.className="pill";b.innerHTML=icon(t)+" "+t;b.addEventListener("click",()=>{if(STATE.selectedTypes.has(t))STATE.selectedTypes.delete(t);else STATE.selectedTypes.add(t);b.classList.toggle("active");render();initMap(true)});typeCont.appendChild(b)});

    // ========= HEADER BUTTONS =========
    $("#brand").addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"});render();initMap(true)});
    $("#btn-explore").addEventListener("click",()=>{$("#grid").scrollIntoView({behavior:"smooth"})});
    $("#btn-gps").addEventListener("click",()=>{document.getElementById("leaf").scrollIntoView({behavior:"smooth"});initMap(true)});
    $("#btn-install").addEventListener("click",async()=>{
      let deferred=null; window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferred=e},{once:true});
      await sleep(100); if(deferred){deferred.prompt(); await deferred.userChoice;} else alert("Astuce: utilise « Ajouter à l’écran d’accueil »."); });
    $("#btn-abonnement").addEventListener("click",()=> openSheet("#sheet-sign"));
    $("#btn-publish").addEventListener("click",()=> openSheet("#sheet-pub"));
    $("#btn-dash").addEventListener("click",()=> openSheet("#sheet-dash"));
    $("#btn-config").addEventListener("click",()=> openSheet("#sheet-cfg"));

    // ========= FILTER ACTIONS =========
    qsa(".pill[data-mode]").forEach(b=>b.addEventListener("click",()=>{qsa(".pill[data-mode]").forEach(x=>x.classList.remove("active"));b.classList.add("active");STATE.mode=b.dataset.mode;render();initMap(true)}));
    $("#search").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();render();initMap(true)}});
    $("#btn-search").addEventListener("click",()=>{render();initMap(true)});
    $("#sort-by").addEventListener("change",e=>{STATE.sortBy=e.target.value;render()});
    $("#apply-filters").addEventListener("click",()=>{render();initMap(true)});
    $("#reset-filters").addEventListener("click",()=>{STATE={...STATE,mode:"all",city:"",district:"",maxPrice:"",bedrooms:"",query:"",sortBy:"recent",selectedTypes:new Set()};citySel.value="";distSel.innerHTML='<option value="">Quartier</option>';distSel.disabled=true;qsa(".pill[data-mode]").forEach(x=>x.classList.remove("active"));qsa(".pill[data-mode]")[0].classList.add("active");render();initMap(true)});
    $("#bedrooms").addEventListener("change",e=>{STATE.bedrooms=e.target.value;render();initMap(true)});
    $("#max-price").addEventListener("input",e=>{STATE.maxPrice=e.target.value});

    // ========= MAP =========
    let map=null, layer=null, bboxCI=[[4.0,-8.6],[10.7,-2.5]];
    function markerIcon(kind){const emoji=icon(kind);return L.divIcon({className:"",html:`<div style="font-size:22px">${emoji}</div>`,iconSize:[22,22],iconAnchor:[11,11]})}
    function initMap(force=false){
      if(!map){map=L.map('leaf',{zoomControl:true,attributionControl:true});map.fitBounds(bboxCI);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map)}
      if(layer){layer.remove()}
      const filtered = getFiltered();
      const markers=filtered.filter(p=>p.lat&&p.lng).map(p=>L.marker([p.lat,p.lng],{icon:markerIcon(p.kind)}).bindPopup(`<b>${p.title}</b><br>${fmt(p.price)} FCFA<br>${p.city} • ${p.district}`));
      layer=L.layerGroup(markers).addTo(map);
      if(markers.length){try{const group=L.featureGroup(markers);map.fitBounds(group.getBounds(),{padding:[20,20]})}catch(e){map.fitBounds(bboxCI)}}else{map.fitBounds(bboxCI)}
    }
    $("#btn-ci").addEventListener("click",()=>{if(map){map.fitBounds(bboxCI)}else initMap(true)});
    $("#btn-near").addEventListener("click",()=>{if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{if(map){map.setView([pos.coords.latitude,pos.coords.longitude],13)}},()=>alert("Impossible d’obtenir la position"))}else alert("GPS non disponible")});
    $("#btn-near-filter").addEventListener("click",()=>{if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{STATE.listings=loadListings().filter(p=>p.lat&&p.lng && haversine(pos.coords.latitude,pos.coords.longitude,p.lat,p.lng)<=10);render();initMap(true)},()=>alert("Impossible d’obtenir votre position"))}else alert("GPS non disponible")});

    // ========= RENDER GRID =========
    function getFiltered(){
      const list=loadListings();
      const filtered=list
        .filter(p=>[p.title,p.city,p.district,(p.kind||"")].join(" ").toLowerCase().includes(($("#search").value||"").toLowerCase()))
        .filter(p=>(STATE.mode==="all"?true:p.type===STATE.mode))
        .filter(p=>(($("#max-price").value)? p.price<=Number($("#max-price").value):true))
        .filter(p=>(STATE.bedrooms!==""?(p.bedrooms||0)>=Number(STATE.bedrooms):true))
        .filter(p=>(STATE.city? p.city===STATE.city:true))
        .filter(p=>(STATE.district? p.district===STATE.district:true))
        .filter(p=>{if(!STATE.selectedTypes.size) return true; const k=String(p.kind||"").toLowerCase(); return STATE.selectedTypes.has(k) || (k==="hotel" && STATE.selectedTypes.has("hôtel"));})
        .sort((a,b)=>{if(STATE.sortBy==="price-asc")return a.price-b.price; if(STATE.sortBy==="price-desc")return b.price-a.price; if(STATE.sortBy==="area")return (b.area||0)-(a.area||0); if(STATE.sortBy==="recent")return new Date(b.created_at||"2000-01-01")-new Date(a.created_at||"2000-01-01"); return 0});
      return filtered;
    }

    function render(){
      const grid=$("#grid"), empty=$("#empty"); grid.innerHTML="";
      const filtered=getFiltered();
      filtered.forEach(p=>{
        const card=document.createElement("div"); card.className="card";
        const coverBox=document.createElement("div"); coverBox.className="cover-box";
        const img=document.createElement("img"); img.className="cover"; img.alt=p.title; img.src=(p.photos&&p.photos[0])||""; img.loading="lazy"; coverBox.appendChild(img);
        const inner=document.createElement("div"); inner.className="inner";
        const top=document.createElement("div"); top.className="toolbar"; top.style.justifyContent="space-between";
        const title=document.createElement("div"); title.style.fontWeight="700"; title.textContent=`${icon(p.kind)} ${p.title}`;
        const badge=document.createElement("span"); badge.className="badge"; badge.textContent=p.type==="vente"?"À vendre":"À louer";
        top.appendChild(title); top.appendChild(badge);
        const isHotel=(String(p.kind||"").toLowerCase().includes("hôtel")||String(p.kind||"").toLowerCase().includes("hotel"));
        const price=document.createElement("div"); price.style.fontWeight="800"; price.style.margin="6px 0";
        price.innerHTML = p.type==="vente" ? `${fmt(p.price)} <span class="muted">FCFA</span>` : `${fmt(p.price)} <span class="muted">FCFA / ${isHotel?"nuit":"mois"}</span>`;
        const geo=document.createElement("div"); geo.className="muted"; geo.textContent=`${p.city} • ${p.district}`;
        const btns=document.createElement("div"); btns.className="toolbar"; btns.style.marginTop="8px";
        const voir=document.createElement("button"); voir.className="btn install"; voir.textContent="Voir"; voir.onclick=()=>openModal(p.id);
        const fav=document.createElement("button"); fav.className="btn"; fav.textContent=STATE.favs.has(p.id)?"★ Favori":"☆ Favori"; fav.onclick=()=>{if(STATE.favs.has(p.id))STATE.favs.delete(p.id);else STATE.favs.add(p.id);saveFavs();render();updateMetrics();};
        btns.appendChild(voir); btns.appendChild(fav);
        inner.appendChild(top); inner.appendChild(price); inner.appendChild(geo); inner.appendChild(btns);
        card.appendChild(coverBox); card.appendChild(inner); grid.appendChild(card);
      });
      empty.style.display=filtered.length?"none":"block";
      $("#m-ads").textContent = filtered.length;
    }

    // ========= DETAIL MODAL =========
    function openModal(id){
      const p=loadListings().find(x=>x.id===id); if(!p) return;
      STATE.openId=id;
      $("#m-title").textContent = `${icon(p.kind)} ${p.title}`;
      const isHotel=(String(p.kind||"").toLowerCase().includes("hôtel")||String(p.kind||"").toLowerCase().includes("hotel"));
      $("#m-price").textContent = p.type==="vente" ? `${fmt(p.price)} FCFA` : `${fmt(p.price)} FCFA / ${isHotel?"nuit":"mois"}`;
      $("#m-geo").textContent=`${p.city} • ${p.district}`;
      $("#m-specs").textContent=`${p.bedrooms||0} ch • ${p.bathrooms||0} sdb • ${p.area||0} m²`;
      $("#m-desc").textContent = p.desc || "Contactez-nous pour plus d’informations.";
      const favBtn=$("#m-fav"); favBtn.textContent=STATE.favs.has(p.id)?"★ Favori":"☆ Favori";
      favBtn.onclick=()=>{ if(STATE.favs.has(p.id)) STATE.favs.delete(p.id); else STATE.favs.add(p.id); saveFavs(); render(); favBtn.textContent=STATE.favs.has(p.id)?"★ Favori":"☆ Favori"; updateMetrics(); };
      $("#m-close").onclick=()=>$("#modal").classList.remove("open");
      $("#overlay").onclick=()=>$("#modal").classList.remove("open");

      // bouton "Je suis intéressé"
      $("#m-interest").onclick=()=>{
        const txt=encodeURIComponent(`Bonjour, je suis intéressé par: ${p.title} — ${fmt(p.price)} FCFA (${p.city} • ${p.district}).`);
        if(p.owner_whatsapp){
          const tel = cleanPhone(p.owner_whatsapp);
          window.open(`https://wa.me/${tel}?text=${txt}`,'_blank');
        } else if(p.owner_email){
          window.location = `mailto:${p.owner_email}?subject=Intéressé: ${encodeURIComponent(p.title)}&body=${txt}`;
        } else {
          const tel=cleanPhone(siteContacts.whatsapp);
          window.open(`https://wa.me/${tel}?text=${txt}`,'_blank');
        }
      };

      $("#modal").classList.add("open");
    }

    // ========= FAVORIS & METRICS =========
    function saveFavs(){db_set(LS_FAVS,[...STATE.favs])}
    function updateMetrics(){
      $("#m-favs").textContent = (db_get(LS_FAVS,[])||[]).length;
      $("#m-views").textContent = db_get(LS_VIEWS,0);
    }

    // ========= DB (local + supabase si dispo) =========
    function db_get(k,def){try{return JSON.parse(localStorage.getItem(k))??def}catch(e){return def}}
    function db_set(k,v){localStorage.setItem(k,JSON.stringify(v))}
    function loadListings(){
      const local=db_get(LS_LISTINGS,[]);
      const m={};[...SAMPLE,...local].forEach(x=>m[x.id]=x);
      return Object.values(m);
    }
    function saveListing(item){
      const arr=db_get(LS_LISTINGS,[]).filter(x=>x.id!==item.id); arr.push(item); db_set(LS_LISTINGS,arr);
      // tentons aussi Supabase si dispo
      if(supabase){ supabase.from("listings").insert(item).catch(()=>{}); }
    }

    // ========= DISTRICTS (auto-append) =========
    function getDistricts(city){
      const map=db_get(LS_DISTRICTS,{});
      const base=CI_CITIES[city]||[];
      const extra=(map[city]||[]);
      const set=new Set([...base,...extra]); return [...set];
    }
    function addDistrict(city,district){
      if(!city||!district) return;
      const map=db_get(LS_DISTRICTS,{});
      map[city]=map[city]||[];
      if(!map[city].includes(district)) map[city].push(district);
      db_set(LS_DISTRICTS,map);
      // optionnel: Supabase
      if(supabase){ supabase.from("districts").insert({city, district}).catch(()=>{}); }
    }

    // ========= SHEETS & FORMS =========
    function openSheet(sel){const el=$(sel); if(!el) return; el.classList.add("open"); el.setAttribute("aria-hidden","false");}
    function closeSheet(sel){const el=$(sel); if(!el) return; el.classList.remove("open"); el.setAttribute("aria-hidden","true");}
    qsa("[data-close]").forEach(b=>b.addEventListener("click",()=>closeSheet(b.getAttribute("data-close"))));

    // Inscription (enregistre local + supabase si dispo)
    $("#form-sign").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const fd=new FormData(e.target); const userObj=Object.fromEntries(fd.entries());
      userObj.id = `U-${Date.now()}`;
      const users=db_get(LS_USERS,[]); users.push(userObj); db_set(LS_USERS,users);
      if(supabase){ try{ await supabase.from("profiles").insert(userObj); }catch(_e){} }
      alert("Inscription enregistrée ✅"); closeSheet("#sheet-sign");
      // si connecté, remplir la fiche
      $("#fiche-nom").textContent = `${userObj.nom||""} ${userObj.prenoms||""}`.trim() || "-";
      $("#fiche-email").textContent = userObj.email || "-";
      renderDash();
    });

    // Publier
    $("#form-pub").addEventListener("submit",(e)=>{
      e.preventDefault();
      const fd=new FormData(e.target); const o=Object.fromEntries(fd.entries());
      if(o.city && o.district) addDistrict(o.city, o.district);
      const item={
        id:`P-${Date.now()}`,
        title:o.title, type:o.type, kind:o.kind, price:Number(o.price)||0,
        city:o.city||"", district:o.district||"", bedrooms:Number(o.bedrooms)||0, bathrooms:Number(o.bathrooms)||0, area:Number(o.area)||0,
        lat:o.lat?Number(o.lat):null, lng:o.lng?Number(o.lng):null,
        photos:o.photo?[o.photo]:REAL[o.kind]||REAL.villa,
        owner_whatsapp:o.owner_whatsapp||"", owner_email:o.owner_email||"",
        desc:o.desc||"", created_at:new Date().toISOString()
      };
      saveListing(item); render(); initMap(true); alert("Annonce publiée ✅"); closeSheet("#sheet-pub");
    });

    // Dash rendering
    function renderDash(){
      const users=db_get(LS_USERS,[]);
      const ads=loadListings();
      $("#dash-users").innerHTML = users.length ? 
        users.map(u=>`• ${u.nom||""} ${u.prenoms||""} — ${u.email||""} — ${u.fonction||""}`).join("<br>") :
        "<span class='muted'>Aucun inscrit.</span>";
      $("#dash-ads").innerHTML = ads.length ?
        ads.map(a=>`• ${a.title} — ${a.city||""} ${a.district||""} — ${fmt(a.price)} FCFA`).join("<br>") :
        "<span class='muted'>Aucune annonce.</span>";
    }

    // ========= PDF =========
    async function ensureLibs(){ while(!(window.jspdf && window.html2canvas)){ await sleep(50); } }
    async function exportPdf(){
      await ensureLibs();
      const { jsPDF } = window.jspdf;
      const el = document.getElementById("fiche");
      const canvas = await html2canvas(el, { scale:2, backgroundColor:"#ffffff" });
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p","mm","a4");
      const W = pdf.internal.pageSize.getWidth(), H = pdf.internal.pageSize.getHeight();
      const m = 10, imgW = W - m*2, imgH = canvas.height * imgW / canvas.width;
      let left = imgH, pos = m;
      pdf.addImage(imgData,"PNG",m,pos,imgW,imgH);
      left -= (H - m*2);
      while(left>0){ pdf.addPage(); pos = m - (imgH - left); pdf.addImage(imgData,"PNG",m,pos,imgW,imgH); left -= (H - m*2); }
      pdf.save("ma_fiche.pdf");
    }
    $("#btnPdf").addEventListener("click", exportPdf);

    // ========= AUTH (si Supabase dispo, sinon UI locale) =========
    async function refreshUI(user){
      const login = $("#nh-login"), logout = $("#nh-logout"), who = $("#nh-who");
      if (user){
        login.style.display="none"; logout.style.display="flex";
        if (who) who.textContent = user.email || user.id;
        $("#alert-login").style.display = "none";
        $("#fiche-nom").textContent = (user.user_metadata?.name)||"-";
        $("#fiche-email").textContent = user.email || "-";
      } else {
        login.style.display="flex"; logout.style.display="none";
        $("#alert-login").style.display = "block";
        $("#fiche-nom").textContent = "-"; $("#fiche-email").textContent = "-";
      }
    }
    if(supabase){
      supabase.auth.onAuthStateChange(async (_e, session)=>{ await refreshUI(session?.user || null); });
      const { data: { session } } = await supabase.auth.getSession();
      await refreshUI(session?.user || null);
      // pageview globale (si table existe)
      try{ await supabase.from("pageviews").insert({ path: location.pathname }); }catch(_e){}
    } else {
      // local view counter
      db_set(LS_VIEWS, (db_get(LS_VIEWS,0)||0)+1);
      updateMetrics();
    }

    $("#btn-in").addEventListener("click", async()=>{
      if(!supabase){ return alert("Activez Supabase via ⚙️ Config pour se connecter."); }
      const email = $("#nh-email").value, password = $("#nh-password").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message);
    });
    $("#btn-up").addEventListener("click", async()=>{
      if(!supabase){ openSheet("#sheet-sign"); return; }
      const email = $("#nh-email").value, password = $("#nh-password").value || prompt("Choisissez un mot de passe", "");
      if(!email || !password) return;
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) alert(error.message); else alert("Compte créé. Vérifiez vos emails puis connectez-vous.");
    });
    $("#btn-out").addEventListener("click", async()=>{ if(supabase){ await supabase.auth.signOut(); } });

    // ========= CONFIG HANDLERS =========
    $("#cfg-save").addEventListener("click",()=>{
      const url=$("#cfg-url").value.trim(), anon=$("#cfg-anon").value.trim();
      localStorage.setItem(LS_CFG, JSON.stringify({url, anon}));
      alert("Clés enregistrées ✅ Rechargez la page.");
    });
    $("#cfg-clear").addEventListener("click",()=>{ localStorage.removeItem(LS_CFG); alert("Clés effacées. Rechargez la page."); });
    $("#cfg-contacts-save").addEventListener("click",()=>{
      const w=$("#cfg-phone").value.trim(), m=$("#cfg-mail").value.trim(), t=$("#cfg-telegram").value.trim();
      localStorage.setItem(LS_CONTACTS, JSON.stringify({whatsapp:w,email:m,telegram:t}));
      alert("Contacts enregistrés ✅");
    });

    // Pré-remplir la config affichée
    $("#cfg-url").value = SUPABASE_URL || "";
    $("#cfg-anon").value = SUPABASE_ANON || "";
    $("#cfg-phone").value = siteContacts.whatsapp || "";
    $("#cfg-mail").value = siteContacts.email || "";
    $("#cfg-telegram").value = siteContacts.telegram || "";

    // ========= CHATBOT =========
    function botSay(html){ const d=document.createElement("div"); d.className="bot-msg bot-a"; d.innerHTML=html; $("#bot-body").appendChild(d); $("#bot-body").scrollTop=999999; }
    function botUser(text){ const d=document.createElement("div"); d.className="bot-msg bot-u"; d.textContent=text; $("#bot-body").appendChild(d); $("#bot-body").scrollTop=999999; }
    function botQuick(...labels){
      const wrap=document.createElement("div"); wrap.className="quick";
      labels.forEach(l=>{const b=document.createElement("button"); b.textContent=l; b.addEventListener("click",()=>{ $("#bot-input").value=l; $("#bot-send").click(); }); wrap.appendChild(b);});
      const d=document.createElement("div"); d.appendChild(wrap); d.className="bot-msg bot-a"; $("#bot-body").appendChild(d); $("#bot-body").scrollTop=999999;
    }
    function openBot(){ $("#bot").classList.add("open"); if(!$("#bot-body").dataset.greet){ botSay("Bonjour 👋 Bienvenue sur <b>NovalisHabitat.CI</b>. Comment puis-je vous aider ?"); botQuick("Acheter","Louer","Créer un compte","Connexion","Publier","Aide paiement","Parler à un humain"); $("#bot-body").dataset.greet="1";}}
    function closeBot(){ $("#bot").classList.remove("open"); }
    $("#bot-btn").addEventListener("click",openBot);
    $("#bot-x").addEventListener("click",closeBot);
    $("#bot-send").addEventListener("click",()=>{ const v=$("#bot-input").value.trim(); if(!v) return; $("#bot-input").value=""; botUser(v); handleBot(v); });
    $("#bot-input").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();$("#bot-send").click();}});

    function linkWhatsApp(text){ const tel=cleanPhone(siteContacts.whatsapp); return `<a href="https://wa.me/${tel}?text=${encodeURIComponent(text||'Bonjour')}" target="_blank">WhatsApp</a>`; }
    function linkTelegram(){ const t=siteContacts.telegram.startsWith("@")?siteContacts.telegram.slice(1):siteContacts.telegram; return `<a href="https://t.me/${t}" target="_blank">Telegram</a>`; }
    function linkMail(subj,body){ return `<a href="mailto:${siteContacts.email}?subject=${encodeURIComponent(subj||'Demande')}&body=${encodeURIComponent(body||'Bonjour')}" target="_blank">Email</a>`; }
    function cleanPhone(s){ return (s||"").replace(/[^\d]/g,""); }

    function handleBot(msg){
      const m=msg.toLowerCase();
      if(/bonjour|bonsoir|salut/.test(m)){ botSay("Bonjour 😊 Que souhaitez-vous faire ?"); botQuick("Acheter","Louer","Créer un compte","Connexion","Publier","Parler à un humain"); return; }
      if(/cr[eé]er|inscription|inscrire/.test(m)){ botSay("Pour vous inscrire, cliquez sur <b>Inscription</b> (en haut) ou dites <i>Ouvrir Inscription</i>."); botQuick("Ouvrir Inscription"); return; }
      if(/ouvrir inscription/.test(m)){ openSheet("#sheet-sign"); botSay("Fiche d’inscription ouverte ✅"); return; }
      if(/connexion|connecter|se connecter/.test(m)){ botSay("Entrez votre email et mot de passe dans la barre en haut (section Connexion)."); return; }
      if(/publier|annonce/.test(m)){ botSay("Pour publier, cliquez sur <b>Créer une annonce</b>. Un formulaire complet s’ouvrira."); botQuick("Ouvrir Publier"); return; }
      if(/ouvrir publier/.test(m)){ openSheet("#sheet-pub"); botSay("Formulaire de publication ouvert ✅"); return; }
      if(/acheter|achat/.test(m)){ botSay("Très bien 👍 Parcourez les annonces, utilisez les filtres (ville, quartier, prix) et cliquez sur <b>Voir</b> puis <b>Je suis intéressé</b> pour contacter le propriétaire."); return; }
      if(/louer|location/.test(m)){ botSay("D’accord. Filtrez sur <b>À louer</b> puis utilisez <b>Voir</b> → <b>Je suis intéressé</b>."); return; }
      if(/paiement|orange|wave|moov|mtn/.test(m)){ botSay("Le paiement en ligne sera activé plus tard. Pour l’instant l’inscription est gratuite."); return; }
      if(/humain|assistant|conseiller/.test(m)){ botSay(`Je peux vous mettre en relation 👇<br>${linkWhatsApp("Bonjour, j’ai besoin d’aide")} • ${linkTelegram()} • ${linkMail("Assistance","Bonjour, j’ai besoin d’aide")}`); return; }
      if(/whatsapp|telegram|mail|email/.test(m)){ botSay(`Contacts : ${linkWhatsApp()} • ${linkTelegram()} • ${linkMail("Contact","Bonjour")}`); return; }
      botSay("Je n’ai pas bien compris, désolé. Essayez avec : <i>Acheter</i>, <i>Louer</i>, <i>Créer un compte</i>, <i>Connexion</i>, <i>Publier</i>, <i>Parler à un humain</i>.");
      botQuick("Acheter","Louer","Créer un compte","Connexion","Publier","Parler à un humain");
    }

    // ========= METRICS INIT =========
    $("#m-favs").textContent = (db_get(LS_FAVS,[])||[]).length;
    $("#m-views").textContent = db_get(LS_VIEWS,0);

    // ========= CONTACT LINK (footer) =========
    $("#f-contact").addEventListener("click",(e)=>{e.preventDefault(); const txt="Bonjour, j’ai une question."; window.open(`https://wa.me/${cleanPhone(siteContacts.whatsapp)}?text=${encodeURIComponent(txt)}`,'_blank'); });

    // ========= DASH INIT & FIRST RENDER =========
    render(); initMap(true); renderDash(); updateMetrics();

  </script>
</body>
</html>
