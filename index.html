<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NovalisHabitat.CI — V5 (propre)</title>
  <meta name="theme-color" content="#ff7f00"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- ===== CSS (uniquement du CSS ici) ===== -->
  <style>
    :root{--orange:#ff7f00;--green:#10b981;--txt:#0f172a;--muted:#6b7280;--bd:#e5e7eb;--bg:#FFF4E6;--white:#fff}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    a{color:#0ea5e9;text-decoration:none}
    .container{max-width:1120px;margin:0 auto;padding:12px 16px}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--bd)}
    .brand{font-weight:900;display:flex;align-items:center;gap:6px;cursor:pointer}
    .brand i{width:10px;height:10px;border-radius:99px;display:inline-block}.o{background:#ff7f00}.w{background:#e5e7eb}.g{background:#10b981}
    .btn{border:1px solid var(--bd);border-radius:12px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:600}
    .btn.install{background:var(--orange);border-color:var(--orange);color:#fff}
    .pill{border:1px solid var(--bd);border-radius:999px;padding:6px 12px;background:#fff;cursor:pointer}
    .pill.active{background:var(--green);color:#fff;border-color:transparent}
    input,select,textarea{border:1px solid var(--bd);border-radius:12px;padding:8px 12px;background:#fff;font-size:14px}
    .grid{display:grid;gap:16px} @media(min-width:640px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}} @media(min-width:1024px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{border:1px solid var(--bd);border-radius:16px;overflow:hidden;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .cover-box{width:100%;aspect-ratio:16/9;background:#e5e7eb;position:relative;overflow:hidden}
    .cover{width:100%;height:100%;object-fit:cover;display:block}
    .inner{padding:12px}
    .price{font-weight:800;margin:6px 0}.muted{color:var(--muted)} .badge{display:inline-flex;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;font-size:12px;gap:6px}
    #map{border:1px solid var(--bd);border-radius:12px;background:#fff;padding:8px;margin:16px 0}
    #leaf{height:520px;border-radius:12px;overflow:hidden}
    footer{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--bd);z-index:5}
    .foot{max-width:1120px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px;position:relative}
    .foot-right{margin-left:auto}.foot-center{position:absolute;left:50%;transform:translateX(-50%);text-align:center;width:max-content;color:#334155;font-weight:600}
    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}.overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .dialog{position:relative;z-index:1;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);max-width:980px;width:100%;max-height:90vh;display:flex;flex-direction:column}
    .dialog .head{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:12px}.dialog .body{padding:12px;overflow:auto}
    .gallery{position:relative;width:100%;aspect-ratio:16/9;background:#e5e7eb;border-radius:12px;overflow:hidden}
    .gallery img,.gallery video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .25s ease;background:#000}
    .gallery .active{opacity:1}.g-nav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;padding:0 6px}
    .g-btn{background:rgba(0,0,0,.35);color:#fff;border:none;border-radius:10px;padding:6px 10px;cursor:pointer}
    /* NH bar (auth) */
    .nh-bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .nh-btn{padding:8px 12px;border-radius:10px;border:1px solid #2a3355;background:#0d1330;color:#e9eefb;cursor:pointer}
    .nh-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .nh-input{height:40px;border-radius:10px;border:1px solid #2a3355;background:#0d1330;color:#e9eefb;padding:0 10px}
    .nh-hidden{display:none}
  </style>
</head>

<body>

  <!-- ===== NH DROP-IN (PDF + vues + statut) — placé au DÉBUT du <body> ===== -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <div id="nh-pdf-bar" class="container" style="margin:10px auto 0">
    <button id="btnPdf" class="nh-btn">Télécharger ma fiche (PDF)</button>
  </div>
  <section id="fiche" class="container"></section>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL  = "https://qqznxwctxnenxxidaxrm.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxem54d2N0eG5lbnh4aWRheHJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODA0NDEsImV4cCI6MjA3MTE1NjQ0MX0.mIGXN4XYDyqULrqI1wekXb-xQTaHuYxqihRv9lI1ZiU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // Vue page
    (async ()=>{ try{ await supabase.from("pageviews").insert({ path: location.pathname }); }catch(e){} })();

    // Fiche par défaut
    const fiche = document.getElementById("fiche");
    fiche.innerHTML = `
      <div style="padding:16px;border:1px solid #223;border-radius:12px;background:#0f1530;color:#e9eefb;max-width:800px">
        <h2>Ma fiche</h2>
        <p>Nom : <span id="fiche-nom">-</span></p>
        <p>Email : <span id="fiche-email">-</span></p>
      </div>`;

    async function ensureLibs(){ while(!(window.jspdf && window.html2canvas)){ await new Promise(r=>setTimeout(r,50)); } }
    async function exportPdf(){
      await ensureLibs();
      const { jsPDF } = window.jspdf;
      const el = document.getElementById("fiche");
      const canvas = await html2canvas(el, { scale:2, backgroundColor:"#ffffff" });
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p","mm","a4");
      const W = pdf.internal.pageSize.getWidth(), H = pdf.internal.pageSize.getHeight();
      const m = 10, imgW = W - m*2, imgH = canvas.height * imgW / canvas.width;
      let left = imgH, pos = m;
      pdf.addImage(imgData,"PNG",m,pos,imgW,imgH);
      left -= (H - m*2);
      while(left>0){ pdf.addPage(); pos = m - (imgH - left); pdf.addImage(imgData,"PNG",m,pos,imgW,imgH); left -= (H - m*2); }
      pdf.save("ma_fiche.pdf");
    }

    async function setupPDF(){
      const btn = document.getElementById("btnPdf");
      btn.disabled = true; btn.textContent = "Connexion requise";
      const { data: { session } } = await supabase.auth.getSession();
      const u = session?.user;
      if (!u) return;

      const { data: profBase } = await supabase.from("profiles").select("full_name").eq("id", u.id).maybeSingle();
      document.getElementById("fiche-nom").textContent = profBase?.full_name || "-";
      document.getElementById("fiche-email").textContent = u.email || "-";

      const [{ data: st }, { data: prof }] = await Promise.all([
        supabase.from("settings").select("payment_enabled").eq("id","global").maybeSingle(),
        supabase.from("profiles").select("status,paid").eq("id", u.id).maybeSingle(),
      ]);
      const on  = !!st?.payment_enabled;
      const ok  = prof?.status === "approved";
      const paid= !!prof?.paid;

      if (!ok){ btn.disabled=true; btn.textContent="Compte en attente de validation"; return; }
      if (on && !paid){ btn.disabled=true; btn.textContent="Payez 800 FCFA (non payé)"; return; }

      btn.disabled=false; btn.textContent="Télécharger ma fiche (PDF)";
      btn.addEventListener("click", exportPdf);
    }
    setupPDF();
  </script>
  <!-- ===== /NH DROP-IN ===== -->

  <!-- ===== Barre de navigation ===== -->
  <div class="header">
    <div class="container toolbar">
      <div id="brand" class="brand" title="Accueil">
        <span style="color:#ff7f00">Novalis</span><span style="color:#0f172a">Habitat</span><span style="color:#10b981">.CI</span>
        <i class="o"></i><i class="w"></i><i class="g"></i>
      </div>
      <div class="spacer"></div>
      <button id="btn-explore" class="btn">Explorer</button>
      <button id="btn-gps" class="btn">Carte & GPS</button>
      <button id="btn-publish" class="btn">Publier</button>
    </div>
  </div>

  <!-- ===== Barre Supabase (login) ===== -->
  <div class="container">
    <div class="nh-bar">
      <a href="./admin.html" data-admin-link style="display:none" class="nh-btn">Admin</a>
      <div id="nh-login" class="nh-row">
        <input id="nh-email" class="nh-input" type="email" placeholder="Email">
        <input id="nh-password" class="nh-input" type="password" placeholder="Mot de passe">
        <button class="nh-btn" onclick="NH.signIn()">Se connecter</button>
        <button class="nh-btn" onclick="NH.signUp()">Créer un compte</button>
      </div>
      <div id="nh-logout" class="nh-row nh-hidden">
        <span>Connecté : <b id="nh-who"></b></span>
        <button class="nh-btn" onclick="NH.signOut()">Se déconnecter</button>
      </div>
    </div>
    <div class="nh-card" data-pay-section style="display:none;border:1px solid #223;border-radius:12px;background:#0f1530;color:#e9eefb;padding:12px">
      <b>Paiements</b> : activés. Vous pouvez réserver / publier avec options payantes.
    </div>
  </div>

  <!-- ===== Filtres ===== -->
  <div class="container toolbar" style="margin-top:12px">
    <button class="pill active" data-mode="all">Tout</button>
    <button class="pill" data-mode="vente">À vendre</button>
    <button class="pill" data-mode="location">À louer</button>

    <select id="city-filter"><option value="">Ville</option></select>
    <select id="district-filter" disabled><option value="">Quartier</option></select>

    <input type="number" id="max-price" placeholder="Budget max (FCFA)" min="0"/>
    <select id="bedrooms">
      <option value="">Chambres (min)</option><option value="0">Studio</option><option value="1">1+</option><option value="2">2+</option><option value="3">3+</option><option value="4">4+</option>
    </select>

    <span class="spacer"></span>
    <input id="search" placeholder="Rechercher…" style="min-width:220px"/>
    <button id="btn-search" class="btn">Rechercher</button>
    <select id="sort-by"><option value="recent">Tri: Récent</option><option value="price-asc">Tri: Prix ↑</option><option value="price-desc">Tri: Prix ↓</option><option value="area">Tri: Surface</option></select>
  </div>

  <!-- ===== Carte ===== -->
  <section id="map" class="container">
    <div style="font-weight:700;margin-bottom:6px">Carte & GPS — Côte d’Ivoire</div>
    <div class="toolbar" style="gap:8px;margin:8px 0">
      <button id="btn-ci" class="btn">Vue Côte d’Ivoire</button>
      <button id="btn-near" class="btn">Autour de moi</button>
    </div>
    <div id="leaf"></div>
  </section>

  <!-- ===== Grille d’annonces ===== -->
  <main class="container">
    <div id="grid" class="grid" style="padding-bottom:60px"></div>
    <div id="empty" class="muted" style="text-align:center;padding:48px 0;display:none">Aucun résultat. <button class="btn" id="reset-filters">Réinitialiser</button> ✨</div>
  </main>

  <!-- ===== Modal détail ===== -->
  <div id="modal" class="modal">
    <div class="overlay" id="overlay"></div>
    <div class="dialog">
      <div class="head toolbar" style="justify-content:space-between">
        <div style="font-weight:700" id="m-title"></div>
        <div class="toolbar">
          <button class="btn" id="m-share">Partager</button>
          <button class="btn" id="m-fav">☆ Favori</button>
          <button class="btn" id="m-close">Fermer</button>
        </div>
      </div>
      <div class="body">
        <div class="gallery" id="m-gallery"></div>
        <div class="grid" style="grid-template-columns:2fr 1fr;gap:16px;margin-top:12px">
          <div><p id="m-desc" class="muted" style="line-height:1.6"></p></div>
          <div>
            <div class="card" style="padding:12px">
              <div style="font-size:18px;font-weight:700" id="m-price"></div>
              <div class="muted" id="m-geo"></div>
              <div class="muted" id="m-specs"></div>
              <div style="height:1px;background:#e5e7eb;margin:8px 0"></div>
              <div style="font-weight:600">Contacter</div>
              <form id="contact-form" class="toolbar" style="flex-direction:column;align-items:stretch;gap:8px;margin-top:8px">
                <input id="c-name" placeholder="Votre nom" value="Mr Jack"/>
                <input id="c-phone" placeholder="Téléphone (+225 …)" value="+225 0707656306"/>
                <input id="c-email" placeholder="Email" value="contact@novalishabitat.ci"/>
                <textarea id="c-message" rows="3">Bonjour, je suis intéressé.</textarea>
                <div id="c-error" class="muted" style="display:none;color:#991b1b"></div>
                <div id="c-ok" class="muted" style="display:none;color:#166534">Message envoyé ✅</div>
                <button type="submit" class="btn install">Envoyer</button>
              </form>
              <div class="toolbar" style="margin-top:8px">
                <a id="wa-link" class="btn" target="_blank" rel="noreferrer">WhatsApp</a>
                <a id="tg-link" class="btn" target="_blank" rel="noreferrer">Telegram</a>
                <a id="call-link" class="btn" href="#">Appeler</a>
                <a id="mail-link" class="btn" href="#">Email</a>
              </div>
              <div id="admin-actions" class="toolbar" style="margin-top:8px;display:none">
                <button class="btn" id="m-edit">Modifier</button>
                <button class="btn" id="m-del">Supprimer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Modal publier (version légère) ===== -->
  <div id="publish" class="modal">
    <div class="overlay" id="p-overlay"></div>
    <div class="dialog">
      <div class="head toolbar" style="justify-content:space-between">
        <div style="font-weight:700">Publier une annonce</div>
        <div class="toolbar"><button class="btn" id="p-cancel">Fermer</button></div>
      </div>
      <div class="body">
        <form id="publish-form" class="toolbar" style="flex-direction:column;align-items:stretch">
          <input id="f-title" placeholder="Titre (ex: 3 pièces à Marcory)" required />
          <div class="toolbar">
            <select id="f-type"><option value="vente">Vente</option><option value="location">Location</option></select>
            <select id="f-kind"><option>maison</option><option>appartement</option><option>studio</option><option>villa</option><option>terrain</option><option>hôtel</option></select>
          </div>
          <div class="toolbar">
            <select id="f-city"></select>
            <select id="f-district" disabled></select>
          </div>
          <div class="toolbar">
            <input type="number" id="f-price" placeholder="Prix (FCFA)" min="0" required />
            <input type="number" id="f-bed" placeholder="Chambres" min="0" />
            <input type="number" id="f-bath" placeholder="SDB" min="0" />
            <input type="number" id="f-area" placeholder="Surface (m²)" min="0" />
          </div>
          <div class="toolbar">
            <input id="f-lat" placeholder="Latitude" /><input id="f-lng" placeholder="Longitude" />
            <button type="button" class="btn" id="f-gps">Définir via GPS</button>
          </div>
          <textarea id="f-desc" rows="3" placeholder="Description"></textarea>
          <div id="f-error" class="muted" style="display:none;color:#991b1b"></div>
          <div class="toolbar" style="justify-content:flex-end">
            <button type="submit" class="btn install">Envoyer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===== Footer ===== -->
  <footer>
    <div class="foot">
      <div class="foot-right">
        <a href="#" id="f-explore" class="link">Explorer</a> |
        <a href="#" id="f-gps" class="link">Carte GPS</a> |
        <a href="#" id="f-contact" class="link">Contact</a>
      </div>
      <div class="foot-center">© 2025 NovalisHabitat.CI — Abidjan, Côte d’Ivoire</div>
    </div>
  </footer>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ===== JS principal (rendu + carte + filtres) ===== -->
  <script>
    /* ===== Données ===== */
    const CI_CITIES = {
      "Abidjan":["Plateau","Cocody","Yopougon","Abobo","Marcory","Treichville","Koumassi","Port-Bouët","Adjamé","Attécoubé","Bingerville","Anyama"],
      "Bouaké":["Koko","Air France","Dar-Es-Salam","Belleville"],
      "Yamoussoukro":["Morofé","Assabou","Millionnaire"],
      "San-Pédro":["Bardot","Balmer","Sogbô"],
      "Korhogo":["Haoussabougou","Sinistré"],
      "Daloa":["Kennedy","Abattoir"],
      "Man":["Grand-Gbapleu","Libreville"],
      "Gagnoa":["Garahio","Dioulabougou"],
      "Divo":["Plateau","8e Tranche"],
      "Abengourou":["Koumassi","Sogefia"],
      "Bondoukou":["Sokoro","Zanzan"],
      "Odienné":["Sogban","Kakologo"]
    };
    const REAL = {
      villa: ["https://source.unsplash.com/1024x640/?villa,house,modern,africa&sig=11","https://source.unsplash.com/1024x640/?villa,pool,house&sig=12"],
      appartement: ["https://source.unsplash.com/1024x640/?apartment,interior&sig=21","https://source.unsplash.com/1024x640/?apartment,living-room&sig=22"],
      hotel: ["https://source.unsplash.com/1024x640/?hotel,lagoon,water&sig=31","https://source.unsplash.com/1024x640/?hotel,room&sig=32"],
      studio: ["https://source.unsplash.com/1024x640/?studio,apartment,small&sig=41"],
      terrain: ["https://source.unsplash.com/1024x640/?land,plot,field,africa&sig=51"]
    };
    const SAMPLE=[
      {id:"P-002",title:"Villa moderne avec piscine — Cocody",type:"vente",kind:"villa",price:29000000,city:"Abidjan",district:"Cocody",bedrooms:4,bathrooms:3,area:220,lat:5.356,lng:-3.990,photos:REAL.villa,created_at:"2025-06-30T10:00:00Z"},
      {id:"P-001",title:"Appartement 3 pièces — Bouaké",type:"location",kind:"appartement",price:35000,city:"Bouaké",district:"Belleville",bedrooms:2,bathrooms:1,area:68,lat:7.690,lng:-5.030,photos:REAL.appartement,created_at:"2025-07-02T09:00:00Z"},
      {id:"P-004",title:"Hôtel bord lagune — Yamoussoukro",type:"location",kind:"hôtel",price:45000,city:"Yamoussoukro",district:"Morofé",bedrooms:20,bathrooms:20,area:1200,lat:6.820,lng:-5.270,photos:REAL.hotel,created_at:"2025-07-05T15:00:00Z"},
      {id:"P-003",title:"Studio simple — Daloa",type:"location",kind:"studio",price:20000,city:"Daloa",district:"Kennedy",bedrooms:1,bathrooms:1,area:24,lat:6.880,lng:-6.450,photos:REAL.studio,created_at:"2025-07-08T12:00:00Z"},
      {id:"P-005",title:"Terrain à vendre — San-Pédro",type:"vente",kind:"terrain",price:12000000,city:"San-Pédro",district:"Balmer",bedrooms:0,bathrooms:0,area:300,lat:4.748,lng:-6.636,photos:REAL.terrain,created_at:"2025-07-10T11:00:00Z"}
    ];

    /* ===== Helpers & storage ===== */
    const LS_LISTINGS="nh:listings", LS_FAVS="nh:favs", LS_DELETED="nh:deleted", LS_ADMIN="nh:admin";
    const qs=(s,r=document)=>r.querySelector(s), qsa=(s,r=document)=>Array.from(r.querySelectorAll(s)), fmt=n=>(n||0).toLocaleString("fr-FR");
    function db_get(k,def){try{return JSON.parse(localStorage.getItem(k))??def}catch(e){return def}}
    function db_set(k,v){localStorage.setItem(k,JSON.stringify(v))}
    function loadListings(){const del=new Set(db_get(LS_DELETED,[]));const local=db_get(LS_LISTINGS,[]);const m={};[...SAMPLE,...local].forEach(x=>{if(!del.has(x.id))m[x.id]=x});return Object.values(m)}
    function saveListing(list){const arr=db_get(LS_LISTINGS,[]).filter(x=>x.id!==list.id);arr.push(list);db_set(LS_LISTINGS,arr)}
    function deleteListing(id){const del=new Set(db_get(LS_DELETED,[]));del.add(id);db_set(LS_DELETED,[...del])}
    function icon(kind){const k=(kind||"").toLowerCase(); if(k==="hôtel"||k==="hotel") return "🏨"; if(k==="terrain") return "🌍"; if(k==="villa") return "🏡"; if(k==="studio") return "🛏️"; if(k==="appartement") return "🏢"; return "🏠";}

    /* ===== State ===== */
    let STATE={listings:loadListings(),favs:new Set(db_get(LS_FAVS,[])),mode:"all",city:"",district:"",maxPrice:"",bedrooms:"",query:"",sortBy:"recent",openId:null,admin:(localStorage.getItem(LS_ADMIN)==="1")};
    function saveFavs(){db_set(LS_FAVS,[...STATE.favs])}

    /* ===== Header actions ===== */
    function goHome(){window.scrollTo({top:0,behavior:"smooth"}); try{render()}catch(e){} try{initMap(true)}catch(e){}}
    qs("#brand").addEventListener("click",goHome);
    qs("#btn-explore").addEventListener("click",()=>{goHome();qs("#grid").scrollIntoView({behavior:"smooth",block:"start"})});
    qs("#btn-gps").addEventListener("click",()=>{document.getElementById("leaf").scrollIntoView({behavior:"smooth"});initMap(true)});
    qs("#btn-publish").addEventListener("click",()=>{qs("#publish").classList.add("open")});
    qs("#p-cancel").addEventListener("click",()=>qs("#publish").classList.remove("open"));
    qs("#p-overlay").addEventListener("click",()=>qs("#publish").classList.remove("open"));

    /* ===== Filtres ===== */
    const citySel=qs("#city-filter"), distSel=qs("#district-filter");
    Object.keys(CI_CITIES).forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;citySel.appendChild(o)});
    citySel.addEventListener("change",()=>{STATE.city=citySel.value;STATE.district="";distSel.innerHTML='<option value="">Quartier</option>';distSel.disabled=!STATE.city;(CI_CITIES[STATE.city]||[]).forEach(d=>{const o=document.createElement("option");o.value=d;o.textContent=d;distSel.appendChild(o)})});
    distSel.addEventListener("change",()=>{STATE.district=distSel.value});
    qsa(".pill[data-mode]").forEach(b=>b.addEventListener("click",()=>{qsa(".pill[data-mode]").forEach(x=>x.classList.remove("active"));b.classList.add("active");STATE.mode=b.dataset.mode;render();initMap(true)}));
    qs("#search").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();render();initMap(true)}});
    qs("#btn-search").addEventListener("click",()=>{render();initMap(true)});
    qs("#sort-by").addEventListener("change",e=>{STATE.sortBy=e.target.value;render()});
    qs("#reset-filters").addEventListener("click",()=>{STATE={...STATE,mode:"all",city:"",district:"",maxPrice:"",bedrooms:"",query:"",sortBy:"recent"};citySel.value="";distSel.innerHTML='<option value="">Quartier</option>';distSel.disabled=true;qsa(".pill[data-mode]").forEach(x=>x.classList.remove("active"));qsa(".pill[data-mode]")[0].classList.add("active");render();initMap(true)});
    qs("#bedrooms").addEventListener("change",e=>{STATE.bedrooms=e.target.value;render();initMap(true)});
    qs("#max-price").addEventListener("input",e=>{STATE.maxPrice=e.target.value;render();initMap(true)});

    /* ===== Publish ===== */
    const fCity=qs("#f-city"), fDistrict=qs("#f-district");
    ["",...Object.keys(CI_CITIES)].forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c||"Ville";fCity.appendChild(o)});
    fCity.addEventListener("change",()=>{fDistrict.disabled=!fCity.value;fDistrict.innerHTML="";const opt=document.createElement("option");opt.value="";opt.textContent="Quartier";fDistrict.appendChild(opt);(CI_CITIES[fCity.value]||[]).forEach(d=>{const o=document.createElement("option");o.value=d;o.textContent=d;fDistrict.appendChild(o)})});
    qs("#f-gps").addEventListener("click",()=>{if(!navigator.geolocation){alert("GPS non disponible");return}navigator.geolocation.getCurrentPosition(pos=>{qs("#f-lat").value=pos.coords.latitude.toFixed(6);qs("#f-lng").value=pos.coords.longitude.toFixed(6)},()=>alert("Impossible d’obtenir la position"))});
    qs("#publish-form").addEventListener("submit",(e)=>{
      e.preventDefault();
      const err=qs("#f-error"); err.style.display='none';
      const title=qs("#f-title").value.trim(); const type=qs("#f-type").value; const kind=qs("#f-kind").value;
      const city=fCity.value; const district=fDistrict.value; const price=Number(qs("#f-price").value||0);
      if(!title||!city||!district||!price){ err.textContent="Merci de compléter les champs requis."; err.style.display='block'; return; }
      const photos = (REAL[kind]||REAL.villa);
      const item={id:`P-${Date.now()}`,title,type,kind,city,district,price,currency:"XOF",
        bedrooms:Number(qs("#f-bed").value||0),bathrooms:Number(qs("#f-bath").value||0),area:Number(qs("#f-area").value||0),
        lat:Number(qs("#f-lat").value||0)||null,lng:Number(qs("#f-lng").value||null)||null,
        photos, videos:[], created_at:new Date().toISOString() };
      const arr=db_get(LS_LISTINGS,[]).filter(x=>x.id!==item.id); arr.push(item); db_set(LS_LISTINGS,arr);
      STATE.listings=loadListings(); qs("#publish").classList.remove("open"); render(); initMap(true); alert("Annonce publiée ✅");
    });

    /* ===== Détail ===== */
    const modal=qs("#modal"); qs("#overlay").addEventListener("click",()=>modal.classList.remove("open")); qs("#m-close").addEventListener("click",()=>modal.classList.remove("open"));
    qs("#m-share").addEventListener("click",async()=>{const p=STATE.listings.find(x=>x.id===STATE.openId); if(!p) return; const text=`${p.title}\n${fmt(p.price)} FCFA • ${p.city} ${p.district}`; if(navigator.share){try{await navigator.share({title:p.title,text})}catch(e){}}else{try{await navigator.clipboard.writeText(text);alert("Détails copiés ✅")}catch(e){alert(text)}}});
    qs("#contact-form").addEventListener("submit",(e)=>{e.preventDefault();qs("#c-error").style.display='none';qs("#c-ok").style.display='block';setTimeout(()=>qs("#c-ok").style.display='none',1200)});

    function buildGallery(el, photos, videos){
      el.innerHTML=""; const wrap=document.createElement("div"); wrap.className="gallery"; const slides=[];
      (videos||[]).forEach((src)=>{const v=document.createElement("video");v.src=src;v.controls=true;slides.push(v);wrap.appendChild(v)});
      (photos||[]).forEach((src)=>{const img=document.createElement("img");img.src=src;img.loading="lazy";img.decoding="async";slides.push(img);wrap.appendChild(img)});
      if(slides.length){slides[0].classList.add("active")}
      const nav=document.createElement("div"); nav.className="g-nav";
      const prev=document.createElement("button"); prev.className="g-btn"; prev.textContent="‹";
      const next=document.createElement("button"); next.className="g-btn"; next.textContent="›";
      nav.appendChild(prev); nav.appendChild(next); wrap.appendChild(nav);
      let idx=0; function show(i){slides.forEach(x=>x.classList.remove("active")); idx=(i+slides.length)%slides.length; slides[idx].classList.add("active")}
      prev.onclick=()=>show(idx-1); next.onclick=()=>show(idx+1); el.appendChild(wrap);
    }
    function openModal(id){
      const p=STATE.listings.find(x=>x.id===id); if(!p) return; STATE.openId=id;
      qs("#m-title").textContent=`${icon(p.kind)} ${p.title}`; buildGallery(qs("#m-gallery"), p.photos, p.videos);
      const isHotel=(String(p.kind||"").toLowerCase().includes("hôtel")||String(p.kind||"").toLowerCase().includes("hotel"));
      qs("#m-price").textContent = p.type==="vente" ? `${fmt(p.price)} FCFA` : `${fmt(p.price)} FCFA / ${isHotel?"nuit":"mois"}`;
      qs("#m-geo").textContent=`${p.city} • ${p.district}`; qs("#m-specs").textContent=`${p.bedrooms||0} ch • ${p.bathrooms||0} sdb • ${p.area||0} m²`;
      const tel="+2250707656306"; qs("#call-link").href=`tel:${tel}`; const mail="contact@novalishabitat.ci"; qs("#mail-link").href=`mailto:${mail}?subject=`+encodeURIComponent(p.title);
      const wa="225707656306"; qs("#wa-link").href="https://wa.me/"+wa+"?text="+encodeURIComponent("Bonjour, je suis intéressé."); qs("#tg-link").href="https://t.me/+225707656306";
      const favBtn=qs("#m-fav"); favBtn.textContent=STATE.favs.has(p.id)?"★ Favori":"☆ Favori";
      favBtn.onclick=()=>{ if(STATE.favs.has(p.id)) STATE.favs.delete(p.id); else STATE.favs.add(p.id); saveFavs(); render(); favBtn.textContent=STATE.favs.has(p.id)?"★ Favori":"☆ Favori"; };
      qs("#admin-actions").style.display = STATE.admin ? "flex":"none";
      qs("#m-del").onclick=()=>{if(confirm("Supprimer cette annonce ?")){deleteListing(p.id);STATE.listings=loadListings();modal.classList.remove("open");render();initMap(true)}};
      qs("#m-edit").onclick=()=>{const nv=prompt("Nouveau titre:",p.title);if(nv){p.title=nv;saveListing(p);STATE.listings=loadListings();render();alert("Modifié ✅")}};
      modal.classList.add("open");
    }

    /* ===== Rendu ===== */
    function render(){
      const filtered=(STATE.listings||[])
        .filter(p=>[p.title,p.city,p.district,(p.kind||"")].join(" ").toLowerCase().includes((qs("#search").value||"").toLowerCase()))
        .filter(p=>(STATE.mode==="all"?true:p.type===STATE.mode))
        .filter(p=>(qs("#max-price").value? p.price<=Number(qs("#max-price").value):true))
        .filter(p=>(STATE.bedrooms!==""?(p.bedrooms||0)>=Number(STATE.bedrooms):true))
        .filter(p=>(STATE.city? p.city===STATE.city:true))
        .filter(p=>(STATE.district? p.district===STATE.district:true))
        .sort((a,b)=>{if(STATE.sortBy==="price-asc")return a.price-b.price; if(STATE.sortBy==="price-desc")return b.price-a.price; if(STATE.sortBy==="area")return (b.area||0)-(a.area||0); if(STATE.sortBy==="recent")return new Date(b.created_at||"2000-01-01")-new Date(a.created_at||"2000-01-01"); return 0});
      const grid=qs("#grid"), empty=qs("#empty"); grid.innerHTML="";
      filtered.forEach(p=>{
        const card=document.createElement("div"); card.className="card";
        const coverBox=document.createElement("div"); coverBox.className="cover-box";
        const img=document.createElement("img"); img.className="cover"; img.alt=p.title; img.src=(p.photos&&p.photos[0])||""; img.loading="lazy"; img.decoding="async"; coverBox.appendChild(img);
        const inner=document.createElement("div"); inner.className="inner";
        const top=document.createElement("div"); top.className="toolbar"; top.style.justifyContent="space-between";
        const title=document.createElement("div"); title.style.fontWeight="700"; title.textContent=`${icon(p.kind)} ${p.title}`;
        const badge=document.createElement("span"); badge.className="badge"; badge.textContent=p.type==="vente"?"À vendre":"À louer";
        top.appendChild(title); top.appendChild(badge);
        const isHotel=(String(p.kind||"").toLowerCase().includes("hôtel")||String(p.kind||"").toLowerCase().includes("hotel"));
        const price=document.createElement("div"); price.className="price";
        price.innerHTML = p.type==="vente" ? `${fmt(p.price)} <span class="muted">FCFA</span>` : `${fmt(p.price)} <span class="muted">FCFA / ${isHotel?"nuit":"mois"}</span>`;
        const geo=document.createElement("div"); geo.className="muted"; geo.textContent=`${p.city} • ${p.district}`;
        const btns=document.createElement("div"); btns.className="toolbar"; btns.style.marginTop="8px";
        const voir=document.createElement("button"); voir.className="btn install"; voir.textContent="Voir"; voir.onclick=()=>openModal(p.id);
        const fav=document.createElement("button"); fav.className="btn"; fav.textContent=STATE.favs.has(p.id)?"★ Favori":"☆ Favori"; fav.onclick=()=>{if(STATE.favs.has(p.id))STATE.favs.delete(p.id);else STATE.favs.add(p.id);saveFavs();render();};
        btns.appendChild(voir); btns.appendChild(fav);
        inner.appendChild(top); inner.appendChild(price); inner.appendChild(geo); inner.appendChild(btns);
        card.appendChild(coverBox); card.appendChild(inner); grid.appendChild(card);
      });
      empty.style.display=filtered.length?"none":"block";
    }

    /* ===== Carte ===== */
    let map=null, layer=null, bboxCI=[[4.0,-8.6],[10.7,-2.5]];
    function markerIcon(kind){const emoji=icon(kind);return L.divIcon({className:"",html:`<div style="font-size:22px">${emoji}</div>`,iconSize:[22,22],iconAnchor:[11,11]})}
    function initMap(){
      if(!map){map=L.map('leaf',{zoomControl:true,attributionControl:true});map.fitBounds(bboxCI);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map)}
      if(layer){layer.remove()}
      const max=Number(qs("#max-price").value||0);
      const filtered=(STATE.listings||[])
        .filter(p=>[p.title,p.city,p.district,(p.kind||"")].join(" ").toLowerCase().includes((qs("#search").value||"").toLowerCase()))
        .filter(p=>(STATE.mode==="all"?true:p.type===STATE.mode))
        .filter(p=>(max? p.price<=max:true))
        .filter(p=>(STATE.city? p.city===STATE.city:true))
        .filter(p=>(STATE.district? p.district===STATE.district:true));
      const markers=filtered.filter(p=>p.lat&&p.lng).map(p=>L.marker([p.lat,p.lng],{icon:markerIcon(p.kind)}).bindPopup(`<b>${p.title}</b><br>${fmt(p.price)} FCFA<br>${p.city} • ${p.district}`));
      layer=L.layerGroup(markers).addTo(map);
      if(markers.length){try{const group=L.featureGroup(markers);map.fitBounds(group.getBounds(),{padding:[20,20]})}catch(e){map.fitBounds(bboxCI)}}else{map.fitBounds(bboxCI)}
    }
    qs("#btn-ci").addEventListener("click",()=>{if(map){map.fitBounds(bboxCI)}else initMap(true)});
    qs("#btn-near").addEventListener("click",()=>{if(!navigator.geolocation){alert("GPS non disponible");return}navigator.geolocation.getCurrentPosition(pos=>{if(!map) initMap(); map.setView([pos.coords.latitude,pos.coords.longitude],12)},()=>alert("Impossible d’obtenir la position"))});

    /* ===== Init ===== */
    function init(){
      // villes pour le formulaire publier
      const fCity=qs("#f-city"), fDist=qs("#f-district");
      fCity.innerHTML=""; ["",...Object.keys(CI_CITIES)].forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c||"Ville";fCity.appendChild(o)});
      fDist.innerHTML='<option value="">Quartier</option>';
      render(); initMap(true);
    }
    init();
  </script>

  <!-- ===== Supabase UI (auth) ===== -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://qqznxwctxnenxxidaxrm.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxem54d2N0eG5lbnh4aWRheHJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODA0NDEsImV4cCI6MjA3MTE1NjQ0MX0.mIGXN4XYDyqULrqI1wekXb-xQTaHuYxqihRv9lI1ZiU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);
    const $ = (s)=>document.querySelector(s);

    async function refreshUI(user){
      try{
        const { data: st } = await supabase.from("settings").select("payment_enabled").eq("id","global").maybeSingle();
        const enabled = st && st.payment_enabled !== false;
        const pay = document.querySelector("[data-pay-section]");
        if (pay) pay.style.display = enabled ? "" : "none";
      }catch(e){}
      const adminLink = document.querySelector("[data-admin-link]");
      if (adminLink){
        if (!user) adminLink.style.display = "none";
        else {
          const { data: meAdmin } = await supabase.from("admins").select("user_id").eq("user_id", user.id).maybeSingle();
          adminLink.style.display = meAdmin ? "" : "none";
        }
      }
      const login = $("#nh-login"), logout = $("#nh-logout"), who = $("#nh-who");
      if (user){ login?.classList.add("nh-hidden"); logout?.classList.remove("nh-hidden"); if (who) who.textContent = user.email || user.id; }
      else { login?.classList.remove("nh-hidden"); logout?.classList.add("nh-hidden"); }
    }
    async function signIn(){ const email = $("#nh-email").value, password = $("#nh-password").value; const { error } = await supabase.auth.signInWithPassword({ email, password }); if (error) alert(error.message); }
    async function signUp(){ const email = $("#nh-email").value, password = $("#nh-password").value; const { error } = await supabase.auth.signUp({ email, password }); if (error) alert(error.message); else alert("Compte créé. Vérifiez vos emails puis connectez-vous."); }
    async function signOut(){ await supabase.auth.signOut(); }

    window.NH = { signIn, signUp, signOut };
    supabase.auth.onAuthStateChange(async (_e, session)=>{ await refreshUI(session?.user || null); });
    const { data: { session } } = await supabase.auth.getSession(); await refreshUI(session?.user || null);
  </script>
</body>
</html>
